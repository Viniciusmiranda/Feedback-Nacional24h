<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Gestor | Nacional Assist√™ncia</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Chart.js & Google Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Favicon -->
    <link rel="icon" href="images/icon.ico" type="image/x-icon">

    <style>
        :root {
            --primary: #10b981;
            --secondary: #3b82f6;
            --accent: #06b6d4;
            --dark: #0a1628;
            --text: #f0fdf4;
            --text-muted: #cbd5e1;

            /* Dashboard Specific */
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --success: #10b981;
            --danger: #ef4444;
            --gold: #FFD700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: var(--dark);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
            font-family: 'Montserrat', sans-serif;
        }

        /* Background animado */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .gradient-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: float 20s infinite ease-in-out;
        }

        .orb1 {
            width: 500px;
            height: 500px;
            background: var(--primary);
            top: -200px;
            left: -200px;
            animation-delay: 0s;
        }

        .orb2 {
            width: 400px;
            height: 400px;
            background: var(--secondary);
            bottom: -150px;
            right: -150px;
            animation-delay: 5s;
        }

        .orb3 {
            width: 350px;
            height: 350px;
            background: var(--accent);
            top: 50%;
            left: 50%;
            animation-delay: 10s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            25% {
                transform: translate(50px, 100px) scale(1.1);
            }

            50% {
                transform: translate(-30px, 50px) scale(0.9);
            }

            75% {
                transform: translate(30px, -50px) scale(1.05);
            }
        }

        /* Scrollbar aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 4px;
        }

        /* GLASS MORPHISM UTILS */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        /* SIDEBAR */
        .sidebar {
            width: 280px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 30px;
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: transform 0.3s ease;
            background: rgba(10, 22, 40, 0.6);
            /* Dark Glass for Harmony */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.3);
        }

        .logo-area {
            margin-bottom: 50px;
            text-align: center;
        }

        .logo-area img {
            max-width: 100%;
            height: auto;
            opacity: 0.9;
            transition: all 0.3s;
        }

        /* Filter only for default logo to make it white */
        .logo-default-filter {
            filter: brightness(0) invert(1) drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
        }

        .logo-area img:hover {
            opacity: 1;
        }

        .logo-default-filter:hover {
            filter: brightness(0) invert(1) drop-shadow(0 0 8px rgba(255, 255, 255, 0.6));
        }

        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
            /* Take available space */
            overflow-y: auto;
            /* Scroll if needed */
            margin-right: -10px;
            /* Adjust for scrollbar padding */
            padding-right: 10px;
            /* Hide Scrollbar for cleaner look (Firefox) */
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
        }

        /* Webkit Scrollbar for Sidebar */
        .nav-links::-webkit-scrollbar {
            width: 4px;
        }

        .nav-links::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .nav-item {
            padding: 16px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-muted);
            /* Revert to light/muted text */
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            border: 1px solid transparent;
        }

        .nav-item.active,
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            /* Removed accent border for cleaner look */
        }

        .nav-icon {
            font-size: 1.2rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            margin-left: 280px;
            /* sidebar width */
            padding: 40px;
            width: calc(100% - 280px);
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .page-title h1 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(90deg, #fff, #a5a5a5);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-title p {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .header-actions {
            display: flex;
            gap: 20px;
        }

        .btn-glow {
            padding: 12px 25px;
            background: var(--accent-neon);
            color: #fff;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(43, 29, 167, 0.6);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-glow:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(43, 29, 167, 0.8), 0 0 10px rgba(255, 255, 255, 0.2);
        }

        /* TOP METRICS GRID */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .metric-card {
            padding: 25px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.06);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--accent-neon), transparent);
        }

        .metric-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .metric-trend {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        /* CHARTS SECTION */
        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 40px;
        }

        .chart-container {
            padding: 25px;
            height: 400px;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* TABLE SECTION */
        .table-section {
            padding: 30px;
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
        }

        .search-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 15px;
            color: #fff;
            width: 300px;
            display: flex;
            align-items: center;
        }

        .search-box input {
            background: transparent;
            border: none;
            color: #fff;
            width: 100%;
            margin-left: 10px;
            outline: none;
        }

        .filters {
            display: flex;
            gap: 15px;
        }

        .filter-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            outline: none;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 15px;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table td {
            padding: 18px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.95rem;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .stars-display {
            color: var(--gold);
            letter-spacing: 2px;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-attendant {
            background: rgba(43, 29, 167, 0.3);
            color: #8eaeff;
        }

        .badge-device {
            background: rgba(255, 255, 255, 0.1);
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 999;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            width: 90%;
            max-width: 450px;
            padding: 40px;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        /* MOBILE TOGGLE & OVERLAY */
        .menu-toggle {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            margin-right: 15px;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 90;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .menu-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                /* Keep correct width */
                padding: 30px;
                /* Ensure it sits on top of overlay */
                z-index: 100;
                background: #0a1628;
                /* Solid bg for visibility */
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 20px;
            }

            .charts-row {
                grid-template-columns: 1fr;
            }

            .header-actions {
                flex-wrap: wrap;
            }
        }

        /* SMARTPHONE MOCKUP FRAME */
        .smartphone-frame {
            width: 300px;
            height: 600px;
            background: #000;
            border-radius: 40px;
            border: 12px solid #333;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            overflow: hidden;
            margin: 0 auto;
        }

        .smartphone-frame .notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 25px;
            background: #000;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            z-index: 10;
        }
    </style>

</head>

<body>
    <!-- Background Animado -->
    <div class="animated-bg">
        <div class="gradient-orb orb1"></div>
        <div class="gradient-orb orb2"></div>
        <div class="gradient-orb orb3"></div>
    </div>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="logo-area">
            <img id="sidebarLogo" src="/logo.png" alt="AvalieJ√° Logo" class="logo-default-filter">
        </div>

        <div class="nav-links">
            <!-- SaaS Admin Section (Initial Hidden) -->
            <div id="adminNav"
                style="display: none; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 15px; padding-bottom: 15px;">
                <p
                    style="padding: 10px 15px 5px 15px; font-size: 0.65rem; color: var(--accent); font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">
                    SaaS Admin</p>
                <a href="#" class="nav-item" onclick="switchTab('adminDashboard', this)">
                    <span class="nav-icon">üìà</span>
                    SaaS Dashboard
                </a>
                <a href="#" class="nav-item" onclick="switchTab('adminCompanies', this)">
                    <span class="nav-icon">üè¢</span>
                    Gest√£o Empresas
                </a>
                <a href="#" class="nav-item" onclick="switchTab('adminIntegrations', this)">
                    <span class="nav-icon">üß©</span>
                    Gest√£o Integra√ß√µes
                </a>
            </div>

            <a href="#" class="nav-item active" onclick="switchTab('dashboard', this)">
                <span class="nav-icon">üìä</span>
                Dashboard
            </a>
            <a href="#" class="nav-item" onclick="switchTab('relatorios', this)">
                <span class="nav-icon">üìë</span>
                Relat√≥rios
            </a>

            <a href="#" class="nav-item" onclick="switchTab('attendants', this)">
                <span class="nav-icon">üë©‚Äçüíº</span>
                Atendentes
            </a>
            <a href="#" class="nav-item" onclick="switchTab('integracoes', this)">
                <span class="nav-icon">üîå</span>
                Integra√ß√µes
            </a>
            <a href="#" class="nav-item" onclick="switchTab('personalizacao', this)">
                <span>üé®</span> Personaliza√ß√£o
            </a>
            <a href="#" class="nav-item" onclick="switchTab('ajustes', this)">
                <span>‚öôÔ∏è</span> Minha Conta
            </a>
            <a href="#" class="nav-item" onclick="switchTab('suporte', this)">
                <span class="nav-icon">üéß</span>
                Suporte
            </a>

        </div> <!-- Close nav-links -->

        <!-- Bottom Section (Footer + Logout) Pinned -->
        <div class="sidebar-bottom"
            style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px;">
            <a href="#" class="nav-item" onclick="logout()" style="color: #ef4444; margin-bottom: 0;">
                <span>üö™</span> Sair
            </a>

            <div class="sidebar-footer"
                style="padding: 10px 0; font-size: 0.65rem; color: rgba(255,255,255,0.3); text-align: center;">
                ¬©Ô∏è 2026 Avalia J√°<br>
                v2.2.45
            </div>
        </div>
    </nav>

    <!-- CONTENT -->
    <main class="main-content">

        <!-- HEADER -->
        <header class="header">
            <!-- Mobile Toggle -->
            <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>

            <div class="page-title">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <h1 id="pageTitle">Vis√£o Geral</h1>
                    <span id="planBadge" class="badge"
                        style="background: var(--gold); color: #000; font-weight: bold; display: none;">PLANO
                        GRATIS</span>
                </div>
                <p id="pageSubtitle">Bem-vindo(a), Gestor. Aqui est√£o os resultados em tempo real.</p>
            </div>
            <div class="header-actions">


                <button id="btnAddAttendant" class="btn-glow" onclick="openAttendantModal()" style="display: none;">
                    + Novo Atendente
                </button>
                <div class="glass-panel"
                    style="padding: 10px 20px; border-radius: 30px; display: flex; align-items: center; gap: 10px;">
                    <div
                        style="width: 10px; height: 10px; background: #00e676; border-radius: 50%; box-shadow: 0 0 10px #00e676;">
                    </div>
                    <span style="font-size: 0.9rem;">Sistema Online</span>
                </div>
            </div>
        </header>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="view-section">
            <!-- TOP METRICS -->
            <section class="metrics-grid">
                <div class="metric-card glass-panel">
                    <div class="metric-title">M√©dia Geral</div>
                    <div class="metric-value" style="color: var(--gold);">0.0</div>
                    <div class="metric-trend trend-up">--</div>
                </div>
                <div class="metric-card glass-panel">
                    <div class="metric-title">Total Avalia√ß√µes</div>
                    <div class="metric-value">0</div>
                    <div class="metric-trend trend-up">--</div>
                </div>
                <div class="metric-card glass-panel">
                    <div class="metric-title">NPS Score</div>
                    <div class="metric-value" style="color: #00e676;">0</div>
                    <div class="metric-trend">--</div>
                </div>
                <div class="metric-card glass-panel">
                    <div class="metric-title">Atendentes Ativos</div>
                    <div class="metric-value">0</div>
                    <div class="metric-trend">--</div>
                </div>
            </section>

            <!-- CHARTS ROW -->
            <section class="charts-row">
                <div class="chart-container glass-panel">
                    <div class="chart-header">
                        <div class="chart-title">Desempenho por Atendente (Volume)</div>
                    </div>
                    <canvas id="mainChart"></canvas>
                </div>
                <div class="chart-container glass-panel">
                    <div class="chart-header">
                        <div class="chart-title">Distribui√ß√£o de Notas</div>
                    </div>
                    <canvas id="pieChart"></canvas>
                </div>
            </section>

            <!-- ROW 2: MAP & TREND -->
            <section class="charts-grid" style="grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
                <!-- MAP -->
                <div class="chart-container glass-panel">
                    <div class="chart-header">
                        <div class="chart-title">Mapa de Avalia√ß√µes (Por Estado)</div>
                    </div>
                    <div id="geoChart" style="width: 100%; height: 300px; border-radius: 10px;"></div>
                </div>
                <!-- TREND -->
                <div class="chart-container glass-panel">
                    <div class="chart-header">
                        <div class="chart-title">Tend√™ncia (30 Dias)</div>
                    </div>
                    <canvas id="trendChart"></canvas>
                </div>
            </section>

            <!-- RECENT REVIEWS SECTION (NEW) -->
            <section class="glass-panel" style="padding: 25px; margin-bottom: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>√öltimas 30 Avalia√ß√µes</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-sm"
                            style="background: rgba(255,255,255,0.1); border:none; color: #fff; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                            ‚è≥ Mais Recentes
                        </button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Atendente</th>
                                <th>Data</th>
                                <th>Nota</th>
                                <th>Coment√°rio</th>
                            </tr>
                        </thead>
                        <tbody id="recentReviewsBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                <button id="btnLoadMore" onclick="loadMoreReviews()"
                    style="display: block; width: 100%; padding: 15px; background: rgba(255,255,255,0.05); border: none; color: var(--text-muted); cursor: pointer; margin-top: 10px; border-radius: 8px;">
                    Carregar Mais...
                </button>
            </section>

        </div>

        <!-- VIEW: ATTENDANTS -->
        <div id="view-attendants" class="view-section" style="display: none;">
            <section class="glass-panel" style="padding: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Lista de Atendentes</h2>
                    <div id="atdToolbarHTML" style="display: flex; gap: 15px; align-items: center;">
                        <span id="planUsageText" style="font-size: 0.9rem; color: var(--text-muted);">Uso: --</span>
                        <button onclick="toggleAttendantSort()"
                            style="background: rgba(255,255,255,0.1); border:none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                            ‚áÖ Ordenar
                        </button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>ID</th>
                                <th>Telefone</th>
                                <th>Setor</th>
                                <th>ID Int.</th>
                                <th>Avalia√ß√µes</th>
                                <th>Status</th>
                                <th style="min-width: 150px;">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="attendantsTableBody">
                            <!-- JS Populated -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- VIEW: RELATORIOS (NEW CONSOLIDATED) -->
        <div id="view-relatorios" class="view-section" style="display: none;">

            <!-- Quick Actions Card (Export) -->
            <section class="glass-panel"
                style="padding: 25px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                <div>
                    <h2 style="margin: 0;">Relat√≥rios e An√°lises</h2>
                    <p style="color: var(--text-muted); margin: 5px 0 0 0;">Exporte dados completos ou analise
                        detalhadamente abaixo.</p>
                </div>
                <div style="display: flex; gap: 15px;">
                    <button class="btn-glow" style="background: #1d6f42;" onclick="exportToCSV()">
                        üì• Excel (.csv)
                    </button>
                    <button class="btn-glow" style="background: #b91c1c;" onclick="generatePDF()">
                        üìÑ PDF
                    </button>
                </div>
            </section>

            <!-- Detailed Analysis Section -->
            <section class="glass-panel" style="padding: 0;">
                <!-- Filters Toolbar -->
                <div
                    style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                    <!-- Date Start -->
                    <div style="flex: 1; min-width: 150px;">
                        <label
                            style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px;">In√≠cio:</label>
                        <input type="date" id="reportStartDate" class="glass-panel"
                            style="width: 100%; padding: 10px; color: #fff; border: 1px solid rgba(255,255,255,0.2); outline: none; background: rgba(0,0,0,0.3);">
                    </div>
                    <!-- Date End -->
                    <div style="flex: 1; min-width: 150px;">
                        <label
                            style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px;">Fim:</label>
                        <input type="date" id="reportEndDate" class="glass-panel"
                            style="width: 100%; padding: 10px; color: #fff; border: 1px solid rgba(255,255,255,0.2); outline: none; background: rgba(0,0,0,0.3);">
                    </div>
                    <!-- Search Text -->
                    <div style="flex: 2; min-width: 200px;">
                        <label
                            style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px;">Buscar
                            (Atendente, Cidade, Nota...)</label>
                        <input type="text" id="reportSearchInput" placeholder="Ex: Jo√£o, 5, S√£o Paulo"
                            class="glass-panel"
                            style="width: 100%; padding: 10px; color: #fff; border: 1px solid rgba(255,255,255,0.2); outline: none; background: rgba(0,0,0,0.3);">
                    </div>
                    <!-- Filter Button -->
                    <button class="btn-glow" onclick="applyReportFilters()"
                        style="padding: 10px 20px; margin-bottom: 2px;">
                        üîç Filtrar Resultados
                    </button>
                </div>

                <!-- Table Container -->
                <div style="overflow-x: auto; max-height: 600px;">
                    <table class="data-table" style="width: 100%;">
                        <thead
                            style="position: sticky; top: 0; background: #0a1628; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                            <tr>
                                <th>Atendente</th>
                                <th>Data/Hora</th>
                                <th>Nota</th>
                                <th>Coment√°rio</th>
                                <th>Local (IP)</th>
                                <th>Mapa</th>
                                <th>Cidade/UF</th>
                                <th>A√ß√µes</th>
                                <!-- Removed Disp. -->
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- Populated via JS -->
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    Carregando dados...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination / Load More -->
                <div
                    style="padding: 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); background: rgba(255,255,255,0.01);">
                    <button id="btnLoadMoreReports" onclick="loadMoreReviews('reportsTableBody')"
                        style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); padding: 12px 30px; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-weight: 500;">
                        Carregar Mais Avalia√ß√µes
                    </button>
                </div>
            </section>
        </div>

        <!-- VIEW: GESTORES -->


        <!-- VIEW: INTEGRACOES (REFACTORED) -->
        <div id="view-integracoes" class="view-section" style="display: none;">
            <div style="display: flex; flex-direction: column; gap: 20px;">

                <!-- BUBBLE DOCK (Top Navigation) -->
                <div id="integrationsBubbleDock" class="glass-panel"
                    style="padding: 15px; display: flex; align-items: center; gap: 20px; overflow-x: auto; min-height: 90px;">
                    <!-- Bubbles injected by JS -->
                </div>

                <!-- MAIN STAGE (Content Area) -->
                <div id="integrationsMainStage" class="glass-panel" style="padding: 20px; min-height: 400px;">
                    <p style="text-align: center; color: var(--text-muted); margin-top: 50px;">Selecione uma integra√ß√£o
                        acima para visualizar os dados.</p>
                </div>

            </div>

            <!-- Hidden original container if needed for compatibility (removed active use) -->
            <div id="integrationsContainer" style="display: none;"></div>
            <div id="addIntegrationSection" style="display: none;"></div>
        </div>
        </div>

        <!-- VIEW: MINHA CONTA (Antigo Ajustes) -->
        <div id="view-ajustes" class="view-section" style="display: none;">
            <div style="width: 100%; padding: 0 20px;">
                <h2 style="margin-bottom: 20px;">Configura√ß√µes da Conta</h2>

                <section class="glass-panel" style="padding: 30px;">
                    <!-- COMPANY FORM (Full Width) -->
                    <form onsubmit="saveAccountDetails(event)"
                        style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 40px;">
                        <h3
                            style="margin: 0 0 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                            üè¢ Dados da Empresa</h3>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display:block; margin-bottom: 8px; font-size: 0.9rem; color: #ccc;">Nome
                                    Fantasia</label>
                                <div
                                    style="display: flex; align-items: center; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); padding: 0 15px;">
                                    <span style="font-size: 1.2rem; opacity: 0.7;">üè∑Ô∏è</span>
                                    <input type="text" id="companyNameInput" placeholder="Ex: Doce Sabor"
                                        style="flex: 1; padding: 12px; border: none; background: transparent; color: #fff; outline: none;">
                                </div>
                            </div>

                            <div>
                                <label
                                    style="display:block; margin-bottom: 8px; font-size: 0.9rem; color: #ccc;">Segmento</label>
                                <div
                                    style="display: flex; align-items: center; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); padding: 0 15px;">
                                    <span style="font-size: 1.2rem; opacity: 0.7;">üìä</span>
                                    <select id="companyAreaInput"
                                        style="flex: 1; padding: 12px; border: none; background: transparent; color: #fff; outline: none; cursor: pointer;">
                                        <option value="" style="background: #0a1628;">Selecione...</option>
                                        <option value="varejo" style="background: #0a1628;">Varejo / Loja</option>
                                        <option value="saude" style="background: #0a1628;">Sa√∫de / Cl√≠nica</option>
                                        <option value="servicos" style="background: #0a1628;">Servi√ßos</option>
                                        <option value="alimentacao" style="background: #0a1628;">Alimenta√ß√£o</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-glow" style="align-self: flex-end;">üíæ Salvar Dados</button>
                    </form>

                    <hr style="margin: 30px 0; border: 0; border-top: 1px solid rgba(255,255,255,0.1);">

                    <!-- PLANS SECTION -->
                    <h2 style="margin-bottom: 20px;">Plano e Assinatura</h2>
                    <div id="plansContainer"
                        style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">

                        <!-- GRATIS -->
                        <div class="plan-card" id="plan-GRATIS"
                            style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid transparent;">
                            <h3 style="font-size: 1.2rem; color: #fff;">Gratis</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem;">Avalie</p>
                            <ul
                                style="list-style: none; padding: 0; margin: 20px 0; font-size: 0.85rem; color: #ccc; line-height: 1.6;">
                                <li>‚úì At√© 5 atendentes</li>
                                <li>‚úì Avalia√ß√µes ilimitadas</li>
                                <li>‚úì Dashboard b√°sico</li>
                                <li>‚úì Alerta WhatsApp</li>
                            </ul>
                            <button disabled
                                style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: none; color: #fff; border-radius: 6px;">Atual</button>
                        </div>

                        <!-- PEQUENAS -->
                        <div class="plan-card" id="plan-PEQUENAS"
                            style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid transparent;">
                            <h3 style="font-size: 1.2rem; color: #fff;">Pequenas</h3>
                            <p style="color: var(--accent); font-weight: bold;">R$ 19,90/m√™s</p>
                            <ul
                                style="list-style: none; padding: 0; margin: 20px 0; font-size: 0.85rem; color: #ccc; line-height: 1.6;">
                                <li>‚úì At√© 20 atendentes</li>
                                <li>‚úì Dashboard avan√ßado</li>
                                <li>‚úì Relat√≥rios completos</li>
                                <li>‚úì Suporte priorit√°rio</li>
                            </ul>
                            <a href="https://wa.me/5511999999999?text=Quero%20assinar%20o%20plano%20Pequenas%20Empresas"
                                target="_blank" class="btn-glow"
                                style="display: flex; justify-content: center; text-decoration: none;">Fazer Upgrade</a>
                        </div>

                        <!-- GRANDES -->
                        <div class="plan-card" id="plan-GRANDES"
                            style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid transparent;">
                            <h3 style="font-size: 1.2rem; color: #fff;">Grandes</h3>
                            <p style="color: var(--accent); font-weight: bold;">R$ 49,90/m√™s</p>
                            <ul
                                style="list-style: none; padding: 0; margin: 20px 0; font-size: 0.85rem; color: #ccc; line-height: 1.6;">
                                <li>‚úì Atendentes ilimitados</li>
                                <li>‚úì Dashboard premium</li>
                                <li>‚úì Tudo ilimitado</li>
                                <li>‚úì Suporte priorit√°rio</li>
                            </ul>
                            <a href="https://wa.me/5511999999999?text=Quero%20assinar%20o%20plano%20Grandes%20Empresas"
                                target="_blank" class="btn-glow"
                                style="display: flex; justify-content: center; text-decoration: none;">Fazer Upgrade</a>
                        </div>
                    </div>
                </section>
            </div>
            <div style="max-width: 1000px; margin: 0 auto;">
                <h2 style="margin-bottom: 20px;">Configura√ß√µes da Conta</h2>

                <section class="glass-panel" style="padding: 30px;">
                    <!-- Grid Layout: 2 Columns to avoid scrolling -->
                    <div style="display: grid; grid-template-columns: 300px 1fr; gap: 40px; align-items: start;">

                        <!-- LEFT COL: PROFILE -->
                        <div style="display: flex; flex-direction: column; gap: 20px;">

                            <!-- Profile Card -->
                            <div class="glass-panel"
                                style="padding: 30px; display: flex; flex-direction: column; align-items: center; text-align: center; border: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2);">
                                <div
                                    style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--accent)); display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                                    üë§
                                </div>
                                <h3 id="profileNameDisplay" style="margin: 0; color: #fff; font-size: 1.2rem;">
                                    Carregando...</h3>
                                <p id="profileEmailDisplay"
                                    style="color: var(--text-muted); font-size: 0.85rem; margin: 5px 0 15px 0;">...</p>
                                <span id="profileRoleBadge" class="badge"
                                    style="background: rgba(255,255,255,0.1); padding: 5px 12px; font-size: 0.8rem;">Gestor</span>
                            </div>

                        </div>

                        <!-- RIGHT COL: FORMS -->
                        <div>
                            <!-- COMPANY FORM -->
                            <form onsubmit="saveAccountDetails(event)"
                                style="display: flex; flex-direction: column; gap: 15px;">
                                <h3
                                    style="margin: 0 0 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                                    üè¢ Dados da Empresa</h3>

                                <div>
                                    <label
                                        style="display:block; margin-bottom: 8px; font-size: 0.9rem; color: #ccc;">Nome
                                        Fantasia</label>
                                    <div
                                        style="display: flex; align-items: center; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); padding: 0 15px;">
                                        <span style="font-size: 1.2rem; opacity: 0.7;">üè∑Ô∏è</span>
                                        <input type="text" id="companyNameInput" placeholder="Ex: Doce Sabor"
                                            style="flex: 1; padding: 12px; border: none; background: transparent; color: #fff; outline: none;">
                                    </div>
                                </div>

                                <div>
                                    <label
                                        style="display:block; margin-bottom: 8px; font-size: 0.9rem; color: #ccc;">Segmento</label>
                                    <div
                                        style="display: flex; align-items: center; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); padding: 0 15px;">
                                        <span style="font-size: 1.2rem; opacity: 0.7;">üìä</span>
                                        <select id="companyAreaInput"
                                            style="flex: 1; padding: 12px; border: none; background: transparent; color: #fff; outline: none; cursor: pointer;">
                                            <option value="" style="background: #0a1628;">Selecione...</option>
                                            <option value="varejo" style="background: #0a1628;">Varejo / Loja</option>
                                            <option value="saude" style="background: #0a1628;">Sa√∫de / Cl√≠nica</option>
                                            <option value="servicos" style="background: #0a1628;">Servi√ßos</option>
                                            <option value="alimentacao" style="background: #0a1628;">Alimenta√ß√£o
                                            </option>
                                        </select>
                                    </div>
                            </form>
                        </div>
                    </div>
                </section>
            </div>





            <!-- GESTORES SECTION MOVED HERE -->
            <div style="max-width: 1000px; margin: 40px auto 0 auto;">
                <h2 style="margin-bottom: 20px;">Gestores e Acesso</h2>
                <div class="header-actions" style="margin-bottom: 20px; justify-content: flex-end;">
                    <button class="btn-glow" onclick="openUserModal()">
                        + Novo Gestor
                    </button>
                </div>
                <section class="glass-panel">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>E-mail</th>
                                <th>Cargo</th>
                                <th>Status</th>
                                <th>A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- JS Populated -->
                        </tbody>
                    </table>
                </section>
            </div>

        </div> <!-- End view-ajustes -->

        <!-- VIEW: SUPORTE -->
        <div id="view-suporte" class="view-section" style="display: none;">
            <section class="glass-panel" style="padding: 40px; text-align: center; margin-bottom: 30px;">
                <h2 style="margin-bottom: 20px;">Precisa de Ajuda?</h2>
                <p class="text-muted">Entre em contato: suporte@avaliaja.app.br</p>
                <a href="https://wa.me/5511999999999" target="_blank" class="btn-glow"
                    style="display: inline-flex; margin-top: 20px; text-decoration: none;">
                    Falar no WhatsApp
                </a>
            </section>

            <!-- SUGGESTIONS (New) -->
            <section class="glass-panel" style="padding: 30px; max-width: 800px; margin: 0 auto 30px auto;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <h2 style="margin: 0; font-size: 1.5rem;">üí° Sugest√µes da Comunidade
                        </h2>
                        <p style="color: var(--text-muted); margin: 0; font-size: 0.9rem;">
                            Vote nas melhorias que voc√™ quer ver!</p>
                    </div>
                    <button onclick="openSuggestionModal()" class="btn-glow"
                        style="padding: 8px 15px; font-size: 0.85rem;">+
                        NOVA
                        SUGEST√ÉO</button>
                </div>
                <div id="suggestionsList" style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Loaded via JS -->
                    <p style="text-align:center; color:#666;">Carregando...</p>
                </div>
            </section>

            <section class="glass-panel" style="padding: 40px; max-width: 800px; margin: 0 auto;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px;">
                    <div style="font-size: 2rem;">üöÄ</div>
                    <div>
                        <h2 style="margin: 0;">Novidades e Atualiza√ß√µes</h2>
                        <p style="color: var(--text-muted);">Confira o que h√° de novo no
                            Avalia J√°.</p>
                    </div>
                </div>
                <div id="changelogContent" style="line-height: 1.6; color: #e2e8f0;">
                    Carregando hist√≥rico...
                </div>
            </section>
        </div>

        <!-- VIEW: PERSONALIZA√á√ÉO -->
        <div id="view-personalizacao" class="view-section" style="display: none;">
            <div style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: center;">

                <!-- Controls Column -->
                <div style="flex: 1; min-width: 300px; max-width: 500px;">
                    <section class="glass-panel" style="padding: 30px; margin-bottom: 20px;">
                        <h2 style="margin-bottom: 20px;">Identidade Visual</h2>
                        <p style="color: var(--text-muted); margin-bottom: 20px;">
                            Customize a apar√™ncia em tempo real.
                        </p>
                        <form onsubmit="saveCustomization(event)" style="display: grid; gap: 20px;">
                            <div>
                                <label>Cor Principal</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="color" id="colorInput" value="#4d4dff"
                                        style="border: none; background: none; width: 50px; height: 50px; cursor: pointer;"
                                        oninput="updatePreviewColor(this.value)">
                                    <span style="font-size: 0.9rem; color: #ccc;">Clique para escolher</span>
                                </div>
                            </div>

                            <div>
                                <label>Logotipo</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <label class="btn-glow"
                                        style="margin: 0; cursor: pointer; display: inline-block; font-size: 0.9rem; padding: 10px 15px;">
                                        Escolher Arquivo
                                        <input type="file" id="logoInput" hidden accept="image/*"
                                            onchange="updatePreviewLogo(this)">
                                    </label>
                                    <span style="font-size: 0.8rem; color: #aaa;">Max 2MB (PNG/JPG)</span>
                                </div>
                                <div id="logoPreviewContainer" style="margin-top: 10px; display: none;">
                                    <img id="logoPreviewImg" src="" style="height: 40px; object-fit: contain;">
                                </div>
                            </div>

                            <div>
                                <label>T√≠tulo da Pergunta de Avalia√ß√£o</label>
                                <input type="text" id="questionTitleInput" class="input-light"
                                    placeholder="Ex: Como foi sua experi√™ncia?"
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: #fff;"
                                    oninput="updatePreviewText(this.value)">
                            </div>

                            <div>
                                <label>Link de Redirecionamento (Opcional)</label>
                                <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 5px;">
                                    Ap√≥s avaliar, o cliente ser√° enviado para este link (ex: Google Maps). Deixe
                                    vazio
                                    para mensagem padr√£o.
                                </p>
                                <input type="url" id="redirectUrlInput" class="input-light"
                                    placeholder="https://g.page/..."
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: #fff;">
                            </div>

                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="showObsInput" checked
                                    onchange="togglePreviewObs(this.checked)" style="width: 20px; height: 20px;">
                                <label for="showObsInput" style="margin: 0;">Permitir
                                    coment√°rios
                                    (Observa√ß√£o)</label>
                            </div>

                            <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">

                            <div>
                                <label>Perguntas Adicionais</label>
                                <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 10px;">
                                    Adicione perguntas
                                    extras para o cliente responder (ex: "Como conheceu?").
                                </p>
                                <div id="extraQuestionsList"
                                    style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px;">
                                </div>
                                <button type="button" onclick="addQuestionField()" class="btn-glow"
                                    style="background: rgba(255,255,255,0.1); font-size: 0.8rem; padding: 8px 15px;">+
                                    Adicionar Pergunta</button>
                            </div>

                            <button type="submit" class="btn-glow">üíæ Salvar
                                Altera√ß√µes</button>
                        </form>
                    </section>
                </div>

                <!-- Preview Column (Smartphone) -->
                <div
                    style="flex: 1; min-width: 320px; display: flex; justify-content: center; align-items: flex-start;">
                    <div style="text-align: center;">
                        <span
                            style="display: block; margin-bottom: 10px; color: var(--text-muted); font-size: 0.9rem;">Visualiza√ß√£o
                        </span>
                        <h4 style="margin: 30px 0 10px 0;">Simula√ß√£o (Mobile preview)
                        </h4>
                        <!-- Mobile Frame Container with Scale -->
                        <!-- Mobile Frame Container with Image -->
                        <div
                            style="position: relative; width: 330px; height: 660px; margin: 0 auto; transform: scale(0.85); transform-origin: top center;">
                            <!-- Mockup Frame -->
                            <img src="images/mockup-mobile.png"
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; object-fit: contain;">

                            <!-- Screen Content Area (Adjust padding to fit typical mockups) -->
                            <!-- Assuming a standard modern phone with thin bezels: 
                                 Top: ~15px, Sides: ~12px, Bottom: ~15px 
                                 We use percentages for responsiveness within the container -->
                            <div
                                style="position: absolute; top: 2.5%; left: 4%; width: 92%; height: 95%; z-index: 10; border-radius: 35px; overflow: hidden; background: #000;">
                                <iframe id="mobilePreviewIframe" src="/ex-atd.html"
                                    style="width: 100%; height: 100%; border: none; background: #fff;"></iframe>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- SAAS ADMIN VIEWS -->
    <div id="view-adminDashboard" class="view-section" style="display: none; padding: 20px;">
        <section class="metrics-grid">
            <div class="metric-card glass-panel">
                <div class="metric-title">Empresas Totais</div>
                <div id="adminTotalCompanies" class="metric-value">0</div>
            </div>
            <div class="metric-card glass-panel">
                <div class="metric-title">Total Avalia√ß√µes (Global)</div>
                <div id="adminTotalReviews" class="metric-value">0</div>
            </div>
            <div class="metric-card glass-panel">
                <div class="metric-title">Atendentes Ativos (Geral)</div>
                <div id="adminTotalAttendants" class="metric-value">0</div>
            </div>
            <div class="metric-card glass-panel">
                <div class="metric-title">Empresas Ativas</div>
                <div id="adminActiveCompanies" class="metric-value">0</div>
            </div>
        </section>

        <section class="charts-row" style="margin-top: 30px;">
            <div class="chart-container glass-panel">
                <div class="chart-header">
                    <div class="chart-title">Empresas por Plano</div>
                </div>
                <canvas id="adminPlanChart"></canvas>
            </div>
        </section>
    </div>

    <div id="view-adminCompanies" class="view-section" style="display: none; padding: 20px;">
        <section class="glass-panel" style="padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>Lista de Clientes (Empresas)</h2>
                <div class="glass-panel"
                    style="padding: 5px 15px; display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2);">
                    <span>üîç</span>
                    <input type="text" id="adminSearchCompany" placeholder="Buscar empresa..."
                        style="background: transparent; border: none; color: #fff; padding: 10px; outline: none; width: 250px;">
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead style="border-bottom: 2px solid rgba(255,255,255,0.1);">
                        <tr>
                            <th style="padding: 15px;">Empresa</th>
                            <th style="padding: 15px;">ID</th>
                            <th style="padding: 15px;">Slug</th>
                            <th style="padding: 15px;">Plano</th>
                            <th style="padding: 15px;">Atendentes</th>
                            <th style="padding: 15px;">Reviews</th>
                            <th style="padding: 15px;">Status</th>
                            <th style="padding: 15px;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="adminCompaniesTableBody">
                        <!-- Loaded via JS -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>


    <!-- VIEW: ADMIN INTEGRATIONS MANAGE (New SaaS Tab) -->
    <div id="view-adminIntegrations" class="view-section" style="display: none; padding: 20px;">
        <h2 style="margin-bottom: 20px;">Controle de Integra√ß√µes (SaaS)</h2>

        <section class="glass-panel" style="padding: 20px;">
            <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                <input type="text" id="adminIntSearch" placeholder="Buscar cliente..." class="input-light"
                    style="padding: 10px; border-radius: 5px; width: 300px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #fff;">
            </div>

            <div style="overflow-x: auto;">
                <table class="data-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="padding: 15px;">Empresa</th>
                            <th style="padding: 15px;">WhatsApp</th>
                            <th style="padding: 15px;">LnAssist</th>
                            <th style="padding: 15px;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="adminIntegrationsTableBody">
                        <!-- Loaded via JS -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- ADMIN INTEGRATIONS MODAL -->
    <div class="modal-overlay" id="adminIntegrationsModal">
        <div class="modal-content glass-panel" style="max-width: 500px;">
            <h2 id="adminIntModalTitle">Configurar Integra√ß√µes</h2>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">Habilite e gerencie o acesso
                aos m√≥dulos.</p>

            <form onsubmit="handleAdminUpdateIntegrations(event)"
                style="display: flex; flex-direction: column; gap: 20px;">
                <input type="hidden" id="adminIntCompanyId">

                <!-- WHATSAPP -->
                <div class="glass-panel" style="padding: 15px; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="images/whatsapp.png" style="width: 30px;">
                            <span style="font-weight: bold;">WhatsApp Business</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="chkIntWhatsapp">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>

                <!-- LNASSIST -->
                <div class="glass-panel" style="padding: 15px; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">ü©∫</span>
                            <span style="font-weight: bold;">LnAssist</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="chkIntLnAssist">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
                    <button type="button" class="btn-secondary"
                        onclick="document.getElementById('adminIntegrationsModal').classList.remove('active')">Cancelar</button>
                    <button type="submit" class="btn-glow">Salvar Configura√ß√£o</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADMIN EDIT MODAL -->
    <div class="modal-overlay" id="adminEditModal">
        <div class="modal-content glass-panel" style="max-width: 450px;">
            <h2 id="adminEditModalTitle">Editar Empresa</h2>
            <form onsubmit="handleAdminUpdateCompany(event)"
                style="display: flex; flex-direction: column; gap: 15px; margin-top:20px;">
                <input type="hidden" id="adminEditCompanyId">
                <div>
                    <label style="display:block; margin-bottom: 5px;">Nome da Empresa</label>
                    <input type="text" id="adminEditCompanyName" required class="input-light"
                        style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #fff; border-radius: 8px;">
                </div>
                <div>
                    <label style="display:block; margin-bottom: 5px;">Plano</label>
                    <select id="adminEditCompanyPlan" required class="input-light"
                        style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #fff; border-radius: 8px; cursor: pointer;">
                        <option value="GRATIS">GRATIS</option>
                        <option value="PEQUENAS">PEQUENAS</option>
                        <option value="GRANDES">GRANDES</option>
                    </select>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="adminEditCompanyActive">
                    <label>Empresa Ativa</label>
                </div>

                <div style="margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                    <label style="display:block; margin-bottom: 8px;">Integra√ß√µes Permitidas</label>
                    <div style="display:flex; gap: 15px;">
                        <label style="display:flex; align-items:center; gap:5px;"><input type="checkbox"
                                id="adminIntWhatsapp"> WhatsApp</label>
                        <label style="display:flex; align-items:center; gap:5px;"><input type="checkbox"
                                id="adminIntLnAssist"> LnAssist</label>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button type="button" class="btn-secondary"
                        onclick="document.getElementById('adminEditModal').classList.remove('active')">Cancelar</button>
                    <button type="submit" class="btn-glow">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>
    <!-- USER MODAL (New) -->
    <div class="modal-overlay" id="userModal">
        <div class="modal-content glass-panel" style="max-width: 400px;">
            <h2 style="margin-bottom: 20px;">Convidar Gestor</h2>
            <form onsubmit="handleInviteUser(event)">
                <input type="text" name="name" placeholder="Nome Completo" required
                    style="width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: #fff;">

                <input type="email" name="email" placeholder="E-mail de acesso" required
                    style="width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: #fff;">

                <input type="password" name="password" placeholder="Senha provis√≥ria" required
                    style="width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: #fff;">

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" onclick="document.getElementById('userModal').classList.remove('active')"
                        style="padding: 10px 20px; background: transparent; border: 1px solid rgba(255,255,255,0.3); color: #fff; border-radius: 8px; cursor: pointer;">Cancelar</button>
                    <button type="submit" class="btn-glow">Convidar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ATTENDANT MODAL -->
    <div class="modal-overlay" id="attendantModal">
        <div class="modal-content glass-panel">
            <h2 style="margin-bottom: 20px;">Gerar Link de Atendente</h2>
            <p style="color: var(--text-muted); margin-bottom: 20px;">Crie um link exclusivo para rastrear as avalia√ß√µes
                deste atendente.</p>

            <input type="hidden" id="attendantIdInput">
            <div style="margin-bottom:15px">
                <input type="text" id="attendantNameInput" placeholder="Nome do Atendente (ex: Jo√£o Silva)"
                    style="width: 100%; padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #fff; outline: none; font-size: 1rem;">
            </div>

            <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap: wrap;">
                <input type="text" id="attendantPhoneInput" placeholder="Telefone (ex: 11999999999)"
                    style="flex:1; min-width: 200px; padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #fff; outline: none;">

                <input type="text" id="attendantSectorInput" placeholder="Setor (ex: Vendas)"
                    style="flex:1; min-width: 200px; padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #fff; outline: none;">
            </div>

            <div style="margin-bottom:15px;">
                <input type="text" id="attendantIntegrationIdInput" placeholder="ID Integra√ß√£o"
                    style="width: 100%; padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #fff; outline: none;">
            </div>

            <div style="margin-bottom:20px; display:flex; flex-direction:column; gap:10px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="attendantNotifyInput" checked
                        style="width:20px; height:20px; cursor:pointer; accent-color: var(--primary);">
                    <label for="attendantNotifyInput" style="cursor:pointer; color: #fff; font-weight: 500;">Receber
                        Notifica√ß√µes de Avalia√ß√£o</label>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="attendantActiveInput" checked
                        style="width:20px; height:20px; cursor:pointer; accent-color: var(--primary);">
                    <label for="attendantActiveInput" style="cursor:pointer; color: #fff; font-weight: 500;">Atendente
                        Ativo</label>
                </div>
            </div>

            <div id="resultArea"
                style="display: none; background: rgba(0,0,0,0.4); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <p style="font-size: 0.8rem; color: var(--gold); margin-bottom: 5px;">Link Gerado:</p>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="generatedLink" readonly
                        style="flex: 1; background: transparent; border: none; color: #fff; font-size: 0.9rem;">
                    <button id="btnCopy" onclick="copyLink()"
                        style="background: var(--primary-blue); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Copiar</button>
                </div>
            </div>

            <div style="display: flex; gap: 15px; justify-content: flex-end;">
                <button onclick="closeAttendantModal()"
                    style="padding: 10px 20px; border: 1px solid rgba(255,255,255,0.3); background: transparent; color: #fff; border-radius: 8px; cursor: pointer;">Fechar</button>
                <button onclick="saveAttendant()"
                    style="padding: 10px 20px; background: var(--accent-neon); color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // --- AUTH & STATE ---
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'index.html';

        let globalData = {
            metrics: {},
            reviews: [],
            reports: [], // New for Reports Tab
            attendants: [],
            companyName: '' // Initialize with empty string
        };

        // --- NAVIGATION LOGIC ---
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        function switchView(viewName, navElement) {
            // 1. Update Nav Active State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (navElement) {
                navElement.classList.add('active');
            } else {
                const found = document.querySelector(`.nav-item[onclick*="'${viewName}'"]`);
                if (found) found.classList.add('active');
            }

            // 2. Hide ALL views and sections first
            document.querySelectorAll('.view-section, .content-section').forEach(el => {
                el.style.display = 'none';
            });

            // 3. Update Header Titles
            const titleMap = {
                'dashboard': globalData.companyName || 'Vis√£o Geral',
                'attendants': 'Gest√£o de Atendentes',
                'relatorios': 'Relat√≥rios e An√°lise de Performance',
                'personalizacao': 'Personaliza√ß√£o',
                'ajustes': 'Minha Conta',
                'updates': 'Atualiza√ß√µes do Sistema',
                'integracoes': 'Integra√ß√µes',
                'gestores': 'Gestores',
                'suporte': 'Suporte',
                'adminDashboard': 'SaaS Dashboard',
                'adminCompanies': 'Gest√£o de Clientes',
                'adminIntegrations': 'Gest√£o de Integra√ß√µes SaaS'
            };
            const title = titleMap[viewName] || 'Painel';
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) pageTitle.innerText = title;

            if (viewName === 'dashboard') {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const subt = document.getElementById('pageSubtitle');
                if (subt) subt.innerText = `Bem-vindo(a), ${user.name || 'Gestor'}. Aqui est√£o os resultados em tempo real.`;
            } else {
                const subt = document.getElementById('pageSubtitle');
                if (subt) subt.innerText = 'Gerencie suas configura√ß√µes.';
            }

            // 4. Show the Requested View
            const targetId = `view-${viewName}`;
            const targetEl = document.getElementById(targetId);

            // Fallback for legacy ID naming (e.g. dashboardSection) although we try to standardize on view-*
            const legacyId = `${viewName}Section`;
            const legacyEl = document.getElementById(legacyId);

            if (targetEl) {
                targetEl.style.display = 'block';
                // alert(`DEBUG: Exibindo ${targetId}`); // Uncomment for debugging
            } else if (legacyEl) {
                legacyEl.style.display = 'block';
            } else {
                console.warn(`View not found: ${viewName} (Checked #${targetId} and #${legacyId})`);
                alert(`Erro: Tela n√£o encontrada (${viewName})`);
            }
        }

        function switchTab(tabName, element) {
            // Update Active Class
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            } else {
                // Try to find by onclick
                const found = document.querySelector(`.nav-item[onclick*="'${tabName}'"]`);
                if (found) found.classList.add('active');
            }

            switchView(tabName);

            // Lazy Load Actions
            if (tabName === 'gestores') loadUsers();
            if (tabName === 'attendants') renderAttendantsList(globalData.attendants);
            if (tabName === 'updates') loadChangelog();
            if (tabName === 'suporte') loadChangelog(); // Load updates in Support tab too
            if (tabName === 'relatorios') applyReportFilters(true); // Load initial reports

            // Handle "Novo Atendente" Button Logic
            const btnAdd = document.getElementById('btnAddAttendant');
            if (btnAdd) {
                if (tabName === 'attendants') {
                    btnAdd.style.display = 'flex';
                } else {
                    btnAdd.style.display = 'none';
                }
            }

            if (tabName === 'integracoes') loadIntegrations();
            if (tabName === 'personalizacao') loadCustomization();
            if (tabName === 'suporte') loadSuggestions();
            if (tabName === 'adminDashboard') loadAdminDashboard();
            if (tabName === 'adminCompanies') loadAdminCompanies();
            if (tabName === 'adminIntegrations') loadAdminIntegrations();
        }

        async function loadChangelog() {
            const container = document.getElementById('changelogContent');
            try {
                const res = await fetch('/api/changelog');
                if (!res.ok) throw new Error("Erro ao carregar");

                // Check if we accidentally got HTML (login page or app shell)
                const contentType = res.headers.get("content-type");
                if (contentType && contentType.includes("text/html")) {
                    throw new Error("Arquivo n√£o encontrado (Retornou HTML)");
                }

                const text = await res.text();
                // Parse using Marked (if available) or raw text
                container.innerHTML = typeof marked !== 'undefined' ? marked.parse(text) : `
    <pre>${text}</pre>`;
            } catch (e) {
                console.error(e);
                container.innerHTML = "N√£o foi poss√≠vel carregar o hist√≥rico de vers√µes.";
            }
        }

        // --- CUSTOMIZATION LOGIC ---
        async function loadCustomization() {
            try {
                const res = await fetch('/api/company/settings', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();

                    // Populate Fields
                    if (data.primaryColor) document.getElementById('colorInput').value = data.primaryColor;

                    if (data.settings) {
                        let s = typeof data.settings === 'string' ? JSON.parse(data.settings) : data.settings;
                        if (s) {
                            if (s.questionTitle) document.getElementById('questionTitleInput').value = s.questionTitle;
                            if (s.redirectUrl) document.getElementById('redirectUrlInput').value = s.redirectUrl;
                            if (s.showObservation !== undefined) document.getElementById('showObsInput').checked = s.showObservation;
                        }
                    }

                    if (data.notifications) {
                        let notif = typeof data.notifications === 'string' ? JSON.parse(data.notifications) : data.notifications;
                        if (notif) {
                            // Load N8N Webhook
                            if (notif.webhookUrl && document.getElementById('n8nWebhookInput')) {
                                document.getElementById('n8nWebhookInput').value = notif.webhookUrl;
                            }
                            // Load WhatsApp Numbers
                            if (notif.whatsappNumbers && document.getElementById('whatsappInput')) {
                                document.getElementById('whatsappInput').value = notif.whatsappNumbers.join(', ');
                            }
                            if (notif.notifyRule && document.getElementById('notifyRuleInput')) {
                                document.getElementById('notifyRuleInput').value = notif.notifyRule;
                            }
                        }
                    }

                    // --- Merged Logic from Wrapper ---
                    // Profile
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    const pName = document.getElementById('profileNameDisplay');
                    const pEmail = document.getElementById('profileEmailDisplay');
                    if (pName) pName.innerText = user.name || 'Gestor';
                    if (pEmail) pEmail.innerText = user.email || '';

                    // Account
                    if (data.name && document.getElementById('companyNameInput')) document.getElementById('companyNameInput').value = data.name;
                    if (data.area && document.getElementById('companyAreaInput')) document.getElementById('companyAreaInput').value = data.area;
                    if (data.whatsapp && document.getElementById('whatsappInput')) document.getElementById('whatsappInput').value = data.whatsapp;

                    if (data.logo) {
                        const img = document.getElementById('logoPreviewImg');
                        const container = document.getElementById('logoPreviewContainer');
                        if (img && container) {
                            img.src = data.logo;
                            container.style.display = 'block';
                        }
                        if (document.getElementById('sidebarLogo')) {
                            const sbLogo = document.getElementById('sidebarLogo');
                            sbLogo.src = data.logo;
                            // If it's the default logo path, add filter, else remove it
                            if (data.logo.includes('images/logo.png')) {
                                sbLogo.classList.add('logo-default-filter');
                            } else {
                                sbLogo.classList.remove('logo-default-filter');
                            }
                        }

                        // UPDATE MOCKUP LOGO
                        const iframe = document.getElementById('mobilePreviewIframe');
                        if (iframe) {
                            iframe.onload = () => {
                                updateMockupLogo(data.logo);
                                // Inject Mockup Submit Disable
                                if (iframe.contentWindow) {
                                    iframe.contentWindow.submitToApi = async () => alert('Modo de Simula√ß√£o: Avalia√ß√£o n√£o enviada.');
                                }
                            };
                            // Also try immediately if already loaded
                            updateMockupLogo(data.logo);
                        }
                    }

                    // Load Questions
                    const qList = document.getElementById('extraQuestionsList');
                    if (qList && data.settings && data.settings.questions) {
                        qList.innerHTML = '';
                        data.settings.questions.forEach(q => addQuestionField(q));
                    }
                } else {
                    console.error('API Error:', res.status);
                    alert('Falha ao carregar dados: ' + res.status);
                }
            } catch (e) {
                console.error("Error loading settings", e);
                alert('Erro ao processar personaliza√ß√£o. Verifique o console.');
            }
        }

        async function saveCustomization(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Salvando...";
            btn.disabled = true;

            const formData = new FormData();
            formData.append('primaryColor', document.getElementById('colorInput').value);

            const settings = {
                questionTitle: document.getElementById('questionTitleInput').value,
                redirectUrl: document.getElementById('redirectUrlInput').value,
                showObservation: document.getElementById('showObsInput').checked,
                questions: []
            };

            // Collect Questions
            document.querySelectorAll('.extra-question-input').forEach(inp => {
                if (inp.value.trim()) settings.questions.push(inp.value.trim());
            });

            formData.append('settings', JSON.stringify(settings));

            const logoFile = document.getElementById('logoInput').files[0];
            if (logoFile) {
                formData.append('logo', logoFile);
            }

            try {
                const res = await fetch('/api/company/settings', {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }, // No Content-Type for FormData
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    alert('Altera√ß√µes salvas com sucesso!');
                    // Update preview immediately if logo changed
                    if (data.company.logo) {
                        const img = document.getElementById('logoPreviewImg');
                        const container = document.getElementById('logoPreviewContainer');
                        if (img && container) {
                            img.src = data.company.logo;
                            container.style.display = 'block';
                        }
                        if (document.getElementById('sidebarLogo')) {
                            const sbLogo = document.getElementById('sidebarLogo');
                            sbLogo.src = data.company.logo;
                            // Check if default
                            if (data.company.logo.includes('images/logo.png')) {
                                sbLogo.classList.add('logo-default-filter');
                            } else {
                                sbLogo.classList.remove('logo-default-filter');
                            }
                        }
                    }
                } else {
                    alert('Erro ao salvar.');
                }
            } catch (e) { console.error(e); }

            btn.innerText = originalText;
            btn.disabled = false;
        }

        // --- NEW HELPER FUNCTIONS ---
        function checkPlanLimits(plan, count) {
            const limits = { 'GRATIS': 5, 'PEQUENAS': 20, 'GRANDES': Infinity };
            const limit = limits[plan] || 5;
            const btn = document.querySelector('button[onclick="openAttendantModal()"]');

            if (btn) {
                if (count >= limit) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.title = "Limite do plano atingido";
                } else {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.title = "";
                }
            }
        }

        // --- COLOR GENERATOR ---
        // Vivid Neon Palette for Dark Mode
        const attendantColors = [
            '#FF0055', // Neon Red
            '#00FF99', // Neon Green
            '#00CCFF', // Neon Blue
            '#FFDD00', // Neon Yellow
            '#FF6600', // Neon Orange
            '#CC00FF', // Neon Purple
            '#FF00AA', // Hot Pink
            '#00FFFF', // Cyan
            '#FF3333', // Bright Red
            '#39FF14', // Electric Green
            '#7DF9FF', // Electric Blue
            '#FF1493', // Deep Pink
            '#FFFF00', // Electric Yellow
            '#BF00FF', // Electric Purple
        ];

        function getAttendantColor(name) {
            if (!name) return '#ffffff';
            let hash = 0;
            for (let i = 0; i < name.length; i++) { hash = name.charCodeAt(i) + ((hash << 5) - hash); } const index = Math.abs(hash
                % attendantColors.length); return attendantColors[index];
        } function renderRecentReviews(reviews,
            targetTbodyId = 'recentReviewsBody') {
            const tbody = document.getElementById(targetTbodyId); if (!tbody) return;
            // Clear logic 
            if (globalData.reviewsPage === 1 && targetTbodyId === 'recentReviewsBody') tbody.innerHTML = ''; const
                isDashboard = targetTbodyId === 'recentReviewsBody'; reviews.forEach(item => {
                    const tr = document.createElement('tr');
                    const starsHtml = '‚òÖ'.repeat(item.stars) + '‚òÜ'.repeat(5 - item.stars);
                    const attName = item.attendant ? item.attendant.name : 'Geral';
                    const attColor = getAttendantColor(attName);
                    const date = new Date(item.createdAt);

                    const baseColumns = `
        <td style="white-space: nowrap;"><span class="badge badge-attendant"
                style="color: ${attColor}; border: 1px solid ${attColor}; background: ${attColor}33; font-weight: bold; text-shadow: 0 0 10px ${attColor}44;">${attName}</span>
        </td>
        <td style="white-space: nowrap;">${date.toLocaleDateString()} <small>${date.toLocaleTimeString().slice(0,
                        5)}</small></td>
        <td><span class="stars-display">${starsHtml}</span></td>
        <td>${item.comment || '-'}</td>
        `;

                    if (isDashboard) {
                        tr.innerHTML = baseColumns;
                    } else {
                        // Reports View
                        const ipDisplay = item.ip ? item.ip : 'N/A';
                        const mapsLink = item.location ? `<a href="${item.location}" target="_blank" style="color: #4facfe;">üìç Ver
            Mapa</a>` : '-';
                        const deleteBtn = `
                            <button class="btn-icon delete-btn" onclick="deleteReview('${item.id}')" title="Excluir Avalia√ß√£o" style="background: none; border: none; cursor: pointer; color: #ff5252;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                            </button>
                        `;

                        const fullColumns = baseColumns + `
        <td>${ipDisplay}</td>
        <td>${mapsLink}</td>
        <td>${item.city || '-'} / ${item.state || '-'}</td>
        <td style="text-align: center;">${deleteBtn}</td>
        `;
                        tr.innerHTML = fullColumns;
                    }
                    tbody.appendChild(tr);
                });
        }

        window.deleteReview = async function (id) {
            const result = await Swal.fire({
                title: 'Tem certeza?',
                text: "Voc√™ n√£o poder√° reverter isso!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar',
                background: '#1e1e2d',
                color: '#fff'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/api/avaliacoes/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (res.ok) {
                        Swal.fire({
                            title: 'Exclu√≠do!',
                            text: 'A avalia√ß√£o foi removida.',
                            icon: 'success',
                            background: '#1e1e2d',
                            color: '#fff'
                        });
                        // Refresh Data
                        if (document.getElementById('view-relatorios').style.display !== 'none') {
                            applyReportFilters(true);
                        } else {
                            loadDashboard();
                        }
                    } else {
                        const err = await res.json();
                        throw new Error(err.error || 'Erro ao excluir');
                    }
                } catch (e) {
                    console.error(e);
                    Swal.fire({
                        title: 'Erro!',
                        text: 'N√£o foi poss√≠vel excluir a avalia√ß√£o.',
                        icon: 'error',
                        background: '#1e1e2d',
                        color: '#fff'
                    });
                }
            }
        }

        // --- REPORTS & FILTERING LOGIC ---

        async function applyReportFilters(reset = false) {
            const tbody = document.getElementById('reportsTableBody');
            const btn = document.getElementById('btnLoadMoreReports');

            if (reset) {
                globalData.reports = [];
                globalData.reportsPage = 1;
                tbody.innerHTML = `<tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">Carregando dados...</td>
                </tr>`;
                if (btn) btn.style.display = 'inline-block';
            }

            // Get Filter Values
            const start = document.getElementById('reportStartDate').value;
            const end = document.getElementById('reportEndDate').value;
            const search = document.getElementById('reportSearchInput').value;

            // Build Query
            const params = new URLSearchParams({
                page: globalData.reportsPage || 1,
                limit: 30
            });
            if (start) params.append('startDate', start);
            if (end) params.append('endDate', end);
            if (search) params.append('search', search);

            try {
                const res = await fetch(`/api/avaliacoes/list?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error("Erro na API");

                const newReviews = await res.json();

                if (reset) tbody.innerHTML = ''; // Clear loading message

                if (newReviews.length === 0 && reset) {
                    tbody.innerHTML = `<tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">Nenhuma avalia√ß√£o encontrada com estes filtros.</td>
                    </tr>`;
                    if (btn) btn.style.display = 'none';
                    return;
                }

                if (newReviews.length > 0) {
                    // Store/Append Data
                    globalData.reports = reset ? newReviews : [...globalData.reports, ...newReviews];
                    renderRecentReviews(newReviews, 'reportsTableBody');
                } else {
                    if (btn) {
                        btn.innerText = "Fim dos resultados.";
                        btn.disabled = true;
                        setTimeout(() => {
                            btn.style.display = 'none'; btn.disabled = false; btn.innerText = "Carregar Mais Avalia√ß√µes";
                        }, 3000);
                    }
                }

            } catch (e) {
                console.error(e);
                console.error(e);
                tbody.innerHTML = `<tr>
                            <td colspan="8" style="text-align: center; padding: 20px; color: #ef4444;">Erro ao carregar dados. Tente novamente.</td>
                </tr>`;
            }
        }

        async function loadMoreReviews(targetId) {
            // Handle Dashboard Loading
            if (!targetId || targetId === 'recentReviewsBody') {
                const btn = document.getElementById('btnLoadMore');
                if (btn) btn.innerText = "Carregando...";

                globalData.reviewsPage = (globalData.reviewsPage || 1) + 1;

                try {
                    const res = await fetch(`/ api / avaliacoes / list ? page = ${globalData.reviewsPage}& limit=30`, {
                        headers: { 'Authorization': `Bearer ${token} ` }
                    });
                    const newReviews = await res.json();
                    if (newReviews.length > 0) {
                        renderRecentReviews(newReviews, 'recentReviewsBody');
                        if (btn) btn.innerText = "Carregar Mais...";
                    } else {
                        if (btn) { btn.innerText = "Fim."; btn.disabled = true; }
                    }
                } catch (e) { console.error(e); }
                return;
            }

            if (targetId === 'reportsTableBody') {
                globalData.reportsPage = (globalData.reportsPage || 1) + 1;
                const btn = document.getElementById('btnLoadMoreReports');
                if (btn) btn.innerText = "Carregando...";
                applyReportFilters(false).then(() => {
                    if (btn) btn.innerText = "Carregar Mais Avalia√ß√µes";
                });
            }
        }

        // --- INIT ---
        loadDashboard();
        loadCustomization(); // Fetch settings on load

        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }

        // --- DATA LOADING ---
        async function loadDashboard() {
            // Role Check
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.role === 'SAAS_ADMIN') {
                document.getElementById('adminNav').style.display = 'block';
                // If first load, maybe go to admin dashboard
                if (!window.location.hash || window.location.hash === '#dashboard') {
                    switchTab('adminDashboard');
                    return; // Stop standard dashboard load
                }
            }
            try {
                // Extract slug from URL (e.g., /nacional-24h/dashboard)
                const pathParts = window.location.pathname.split('/');
                const urlSlug = pathParts[1] !== 'dashboard' ? pathParts[1] : null;

                let fetchUrl = '/api/avaliacoes/dashboard';
                if (urlSlug) fetchUrl += `?slug=${urlSlug}`;

                const res = await fetch(fetchUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error("Falha API");

                const data = await res.json();
                globalData = { ...globalData, ...data, reviewsPage: 1 }; // Reset page

                if (planBadge) {
                    planBadge.innerText = `PLANO ${data.plan || 'GRATIS'} `;
                    // Show only if GRATIS
                    if ((data.plan || 'GRATIS') === 'GRATIS') {
                        planBadge.style.display = 'inline-block';
                    } else {
                        planBadge.style.display = 'none';
                    }
                }

                // UPDATE PLAN CARDS
                const currentPlan = data.plan || 'GRATIS';
                document.querySelectorAll('.plan-card').forEach(card => {
                    // Reset
                    card.style.border = "1px solid transparent";
                    card.style.background = "rgba(255,255,255,0.05)";
                    const btn = card.querySelector('a, button');
                    if (btn.tagName === 'BUTTON') {
                        // Reset 'Atual' button check
                        // If it's the current plan card, disable it. If not (downgrade?), maybe keep disabled or hide.
                        // But for simplicity, we re-render buttons via logic below or just class toggle.
                        // Actually simpler:
                    }
                });

                // Highlight Current
                const activeCard = document.getElementById(`plan - ${currentPlan} `);
                if (activeCard) {
                    activeCard.style.border = "2px solid var(--accent)";
                    activeCard.style.background = "rgba(77, 77, 255, 0.1)";
                    // Change button to "Atual"
                    const actionEl = activeCard.querySelector('.btn-glow') || activeCard.querySelector('button');
                    if (actionEl) {
                        const parent = actionEl.parentNode;
                        parent.innerHTML += `< button disabled
                        style = "width: 100%; padding: 10px; background: var(--accent); border: none; color: #fff; border-radius: 6px;" > Plano
            Atual</button > `;
                        actionEl.remove();
                    }
                }


                // Update Header Texts & Sidebar Logo
                const userObj = JSON.parse(localStorage.getItem('user') || '{}');
                document.getElementById('pageTitle').innerText = data.companyName;
                document.getElementById('pageSubtitle').innerText = `Bem - vindo(a), ${userObj.name || 'Gestor'}. Aqui est√£o os resultados em tempo real.`;

                // Update Sidebar Logo if available
                if (data.logo) {
                    const sidebarLogo = document.getElementById('sidebarLogo');
                    if (sidebarLogo) {
                        sidebarLogo.src = data.logo;
                        sidebarLogo.classList.remove('logo-default-filter');
                    }
                }

                // Render All Views
                renderMetrics(data.metrics);
                renderCharts(data.attendants);
                renderTable(data.reviews);

                // New logic (Fixing order and adding new charts)
                renderRecentReviews(data.reviews || []); // Ensure array
                renderAttendantsList(data.attendants);
                checkPlanLimits(data.plan, data.metrics.activeAttendants);

                // Render New Charts (Map + Trend)
                if (google && google.charts) {
                    google.charts.setOnLoadCallback(() => renderNewCharts(data.reviewsByState, data.reviewsByDate));
                }

            } catch (e) {
                console.error(e);
            }
        }

        function renderMetrics(metrics) {
            const cards = document.querySelectorAll('.metric-value');
            if (cards.length >= 4) {
                cards[0].innerText = metrics.average ? metrics.average.toFixed(1) : '0.0';
                cards[1].innerText = metrics.total;
                cards[2].innerText = metrics.nps;
                cards[3].innerText = metrics.activeAttendants;
            }
        }

        let mainChartInstance = null;
        let pieChartInstance = null;

        function renderCharts(attendants) {
            // MAIN CHART
            const ctxMain = document.getElementById('mainChart').getContext('2d');
            const labels = attendants.map(a => a.name);
            const volume = attendants.map(a => a._count.reviews);
            const colors = attendants.map(a => getAttendantColor(a.name));

            if (mainChartInstance) mainChartInstance.destroy();

            mainChartInstance = new Chart(ctxMain, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Desempenho (Volume)',
                        data: volume,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c), // Same color or darken? Same is fine for neon.
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });

            // PIE CHART calculate from reviews
            const starsCount = [0, 0, 0, 0, 0];
            globalData.reviews.forEach(r => {
                if (r.stars >= 1 && r.stars <= 5) starsCount[r.stars - 1]++;
            }); const
                ctxPie = document.getElementById('pieChart').getContext('2d'); if (pieChartInstance)
                pieChartInstance.destroy(); pieChartInstance = new Chart(ctxPie, {
                    type: 'doughnut', data: {
                        labels: ['1 ‚òÖ', '2 ‚òÖ', '3 ‚òÖ', '4 ‚òÖ', '5 ‚òÖ'],
                        datasets: [{
                            data: starsCount,
                            backgroundColor: ['#ff5252', '#ff9100', '#ffd740', '#69f0ae', '#00c853'],
                            borderWidth: 0
                        }]
                    }, options: {
                        responsive: true,
                        maintainAspectRatio: false, plugins: { legend: { position: 'right' } }
                    }
                });
        }

        // --- NEW CHARTS (Map & Trend)--- 
        let trendChartInstance = null;
        function renderNewCharts(byState, byDate) {

            // 1. MAP (Google GeoChart)
            // Transform { 'SP': 10, 'RJ': 5 } to [['State', 'Reviews'], ['BR-SP', 10], ...]
            // Google GeoChart for Brazil uses "BR-XX" codes (ISO 3166-2:BR)
            // Mapping Full Names to ISO Codes
            // Mapping Full Names to ISO Codes (Normalized for robustness)
            const stateMap = {
                'AC': 'BR-AC', 'AL': 'BR-AL', 'AP': 'BR-AP', 'AM': 'BR-AM', 'BA': 'BR-BA', 'CE': 'BR-CE',
                'DF': 'BR-DF', 'ES': 'BR-ES', 'GO': 'BR-GO', 'MA': 'BR-MA', 'MT': 'BR-MT', 'MS': 'BR-MS',
                'MG': 'BR-MG', 'PA': 'BR-PA', 'PB': 'BR-PB', 'PR': 'BR-PR', 'PE': 'BR-PE', 'PI': 'BR-PI',
                'RJ': 'BR-RJ', 'RN': 'BR-RN', 'RS': 'BR-RS', 'RO': 'BR-RO', 'RR': 'BR-RR', 'SC': 'BR-SC',
                'SP': 'BR-SP', 'SE': 'BR-SE', 'TO': 'BR-TO',
                // Full Names (Normalized)
                'ACRE': 'BR-AC', 'ALAGOAS': 'BR-AL', 'AMAPA': 'BR-AP', 'AMAZONAS': 'BR-AM', 'BAHIA': 'BR-BA',
                'CEARA': 'BR-CE', 'DISTRITO FEDERAL': 'BR-DF', 'ESPIRITO SANTO': 'BR-ES', 'GOIAS': 'BR-GO',
                'MARANHAO': 'BR-MA', 'MATO GROSSO': 'BR-MT', 'MATO GROSSO DO SUL': 'BR-MS',
                'MINAS GERAIS': 'BR-MG', 'PARA': 'BR-PA', 'PARAIBA': 'BR-PB', 'PARANA': 'BR-PR',
                'PERNAMBUCO': 'BR-PE', 'PIAUI': 'BR-PI', 'RIO DE JANEIRO': 'BR-RJ',
                'RIO GRANDE DO NORTE': 'BR-RN', 'RIO GRANDE DO SUL': 'BR-RS', 'RONDONIA': 'BR-RO',
                'RORAIMA': 'BR-RR', 'SANTA CATARINA': 'BR-SC', 'SAO PAULO': 'BR-SP', 'SERGIPE': 'BR-SE',
                'TOCANTINS': 'BR-TO'
            };

            const mapData = [['Estado', 'Avalia√ß√µes']];
            if (byState && byState.length > 0) {
                byState.forEach(item => {
                    if (item.state) {
                        // Normalize: Uppercase + Remove Accents
                        let raw = item.state.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();

                        let iso = stateMap[raw];
                        if (!iso) {
                            // Helper to try 2-letter code if raw is length 2
                            if (raw.length === 2) iso = 'BR-' + raw;
                            else iso = 'BR-' + raw; // Fallback
                        }

                        mapData.push([iso, item._count.id]);
                    }
                });
            } else {
                mapData.push(['BR-DF', 0]); // Dummy to render map
            }

            const dataTable = google.visualization.arrayToDataTable(mapData);
            const options = {
                region: 'BR', // Brazil
                displayMode: 'regions',
                resolution: 'provinces',
                colorAxis: { colors: ['#e0f7fa', '#006064'] }, // Light to Dark Blue
                backgroundColor: 'transparent',
                datalessRegionColor: 'rgba(255,255,255,0.05)',
                defaultColor: '#f5f5f5',
            };

            const chart = new google.visualization.GeoChart(document.getElementById('geoChart'));
            chart.draw(dataTable, options);


            // 2. TREND CHART (Chart.js)
            // byDate is { '2025-01-01': 5, ... }
            const ctxTrend = document.getElementById('trendChart').getContext('2d');

            // Generate labels for last 30 days to ensure continuity
            const labels = [];
            const dataPoints = [];
            const today = new Date();
            for (let i = 29; i >= 0; i--) {
                const d = new Date();
                d.setDate(today.getDate() - i);
                const dayStr = d.toISOString().split('T')[0];
                labels.push(dayStr.split('-').slice(1).join('/')); // MM/DD
                dataPoints.push(byDate[dayStr] || 0);
            }

            if (trendChartInstance) trendChartInstance.destroy();

            trendChartInstance = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Avalia√ß√µes Di√°rias',
                        data: dataPoints,
                        borderColor: '#00e676', // Green
                        backgroundColor: 'rgba(0, 230, 118, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Init Google Charts
        google.charts.load('current', {
            'packages': ['geochart'],
            'mapsApiKey': '' // Not needed for simple GeoChart? Check. Yes, old GeoChart (Flash/SVG) works without key usually?
            // Wait, Google Maps Key is required for Geocoding, but visualization.GeoChart uses SVG/VML.
            // It should works.
        });

        function renderTable(reviews) {
            const tbody = document.getElementById('recentReviewsBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            reviews.forEach(item => {
                const tr = document.createElement('tr');
                const starsHtml = '‚òÖ'.repeat(item.stars) + '‚òÜ'.repeat(5 - item.stars);
                const attName = item.attendant ? item.attendant.name : 'Geral';
                const date = new Date(item.createdAt);
                tr.innerHTML = `
                            <td><span class="badge badge-attendant">${attName}</span></td>
            <td>#${item.displayId || '-'}</td>
            <td>${date.toLocaleDateString()} <small>${date.toLocaleTimeString().slice(0, 5)}</small></td>
            <td><span class="stars-display">${starsHtml}</span></td>
            <td>${item.comment || '-'}</td>
            <td>${item.city || '-'} / ${item.state || '-'}</td>
            <td><span class="badge badge-device">${item.device || '?'}</span></td>
                        `;
                tbody.appendChild(tr);
            });
        }

        // --- ATTENDANTS LIST & SORT ---
        let attendantsSort = 'name'; // default

        function toggleAttendantSort() {
            if (attendantsSort === 'name') attendantsSort = 'reviews';
            else attendantsSort = 'name';
            renderAttendantsList(globalData.attendants);
        }

        function renderAttendantsList(attendants) {
            const tbody = document.getElementById('attendantsTableBody');

            // Toolbar is already defined in HTML as 'atdToolbarHTML'

            // Update Limit Text
            const limitTextEl = document.getElementById('planUsageText');
            if (limitTextEl && globalData.plan) {
                const limits = { 'GRATIS': 5, 'PEQUENAS': 20, 'GRANDES': Infinity };
                const limit = limits[globalData.plan] || 5;
                const count = globalData.metrics.activeAttendants || 0;
                const txt = limit === Infinity ? 'Ilimitado' : `${count}/${limit}`;
                limitTextEl.innerHTML = `Uso do Plano: <strong style="color: #fff;">${txt}</strong> atendentes`;
            }

            // SORT DATA
            let sorted = [...attendants];
            if (attendantsSort === 'reviews') {
                sorted.sort((a, b) => b._count.reviews - a._count.reviews);
            } else {
                sorted.sort((a, b) => a.name.localeCompare(b.name));
            }

            tbody.innerHTML = '';
            sorted.forEach(att => {
                const tr = document.createElement('tr');
                const attColor = getAttendantColor(att.name);
                const isActive = att.active !== false; // Default true if undefined
                const statusBadge = isActive
                    ? '<span style="color:#00e676;">Ativo</span>'
                    : '<span style="color:#ef4444;">Inativo</span>';

                tr.innerHTML = `
            <td><b style="color: ${attColor}; font-size: 1.05rem;">${att.name}</b></td>
            <td>#${att.displayId || '-'}</td>
            <td>${att.phone || '-'}</td>
            <td>${att.sector || '-'}</td>
            <td>${att.integrationId || '-'}</td>
            <td>${att._count.reviews} avalia√ß√µes</td>
            <td>${statusBadge}</td>
            <td style="display:flex; gap:10px;">
                <button onclick="openAttendantModal('${att.id}')"
                    style="background:rgba(255,255,255,0.1); border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;"
                    title="Editar">
                    ‚úèÔ∏è
                </button>
                <button id="btn-copy-${att.name}" onclick="copyLinkByName('${att.name}')"
                    style="background:rgba(255,255,255,0.1); border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;"
                    title="Copiar Link">
                    üîó
                </button>
                <button onclick="deleteAttendant('${att.id}', '${att.name}')"
                    style="background:rgba(255,82,82,0.2); border:none; color:#ff5252; padding:5px 10px; border-radius:5px; cursor:pointer;"
                    title="Excluir">
                    üóëÔ∏è
                </button>
            </td>
            `;
                tbody.appendChild(tr);
            });
        }

        // --- FILTERING ---
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = globalData.reviews.filter(d =>
                (d.attendant?.name.toLowerCase().includes(term)) ||
                (d.city?.toLowerCase().includes(term))
            );
            renderTable(filtered);
        });

        // --- EXPORT FUNCTIONS ---

        function getFilteredDataForExport() {
            // If in Reports tab, use the loaded reports
            const reportsView = document.getElementById('view-relatorios');
            if (reportsView && reportsView.style.display !== 'none' && globalData.reports.length > 0) {
                return globalData.reports;
            }

            // Fallback to existing dashboard logic
            const startStr = document.getElementById('reportStartDate')?.value ||
                document.getElementById('dateStart')?.value;
            const endStr = document.getElementById('reportEndDate')?.value || document.getElementById('dateEnd')?.value;

            let data = globalData.reviews;

            if (startStr || endStr) {
                const start = startStr ? new Date(startStr) : new Date(0);
                const end = endStr ? new Date(endStr) : new Date();
                end.setHours(23, 59, 59, 999);

                data = data.filter(r => {
                    const d = new Date(r.createdAt);
                    return d >= start && d <= end;
                });
            } return data;
        } function exportToCSV() {
            const
                data = getFilteredDataForExport(); const rows = [["Atendente", "Data", "Nota", "Comentario", "IP"
                    , "Localizacao", "Cidade", "Estado", "Dispositivo"]]; data.forEach(r => {
                        const attName = r.attendant ? r.attendant.name : 'Geral';
                        const date = new Date(r.createdAt).toLocaleString();

                        rows.push([
                            `"${attName}"`,
                            `"${date}"`,
                            r.stars,
                            `"${(r.comment || '').replace(/"/g, '""')}"`,
                            `"${r.ip || ''}"`,
                            `"${r.location || ''}"`,
                            `"${r.city || ''}"`,
                            `"${r.state || ''}"`,
                            `"${r.device || ''}"`
                        ]);
                    });

            let csvContent = "data:text/csv;charset=utf-8,"
                + rows.map(e => e.join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `avaliaja_relatorio_${Date.now()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function generatePDF() {
            const btn = document.querySelector('button[onclick="generatePDF()"]');
            const originalText = btn ? btn.innerText : '';
            if (btn) btn.innerText = "Gerando PDF...";

            // 1. VISIBILITY ISOLATION STRATEGY
            const originalDisplays = [];
            const bodyChildren = Array.from(document.body.children);
            bodyChildren.forEach(child => {
                if (child.tagName !== 'SCRIPT') {
                    originalDisplays.push({ element: child, display: child.style.display });
                    child.style.display = 'none';
                }
            });

            try {
                // 2. Create Container
                const reportContainer = document.createElement('div');
                reportContainer.style.width = '700px'; // Fit within A4 (794px) with margins
                reportContainer.style.margin = '0 auto';
                reportContainer.style.padding = '20px'; // Reduced padding
                reportContainer.style.background = '#fff';
                reportContainer.style.color = '#333';
                reportContainer.style.fontFamily = 'Montserrat, sans-serif';
                reportContainer.style.height = 'auto'; // Added for instruction
                reportContainer.style.overflow = 'visible'; // Added for instruction

                // Branding
                const primaryColor = globalData.primaryColor || '#2b1da7';
                const logoSrc = globalData.logo || 'images/logo.png';

                const data = getFilteredDataForExport();
                const total = data.length;
                const avg = total > 0 ? (data.reduce((acc, curr) => acc + curr.stars, 0) / total).toFixed(1) : '0.0';

                const promoters = data.filter(r => r.stars >= 5).length;
                const detractors = data.filter(r => r.stars <= 3).length;
                const nps = total > 0 ? Math.round(((promoters - detractors) / total) * 100) : 0;

                // Aggregation: Attendants
                const attendantsMap = {};
                data.forEach(r => {
                    const name = r.attendant ? r.attendant.name : 'Geral';
                    if (!attendantsMap[name]) attendantsMap[name] = { count: 0, sum: 0, stars: [] };
                    attendantsMap[name].count++;
                    attendantsMap[name].sum += r.stars;
                    attendantsMap[name].stars.push(r.stars);
                });

                // Aggregation: Timeline (Daily)
                const timelineMap = {};
                // Sort by date ascending
                const sortedData = [...data].sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                sortedData.forEach(r => {
                    const date = new Date(r.createdAt).toLocaleDateString('pt-BR');
                    if (!timelineMap[date]) timelineMap[date] = 0;
                    timelineMap[date]++;
                });
                const dates = Object.keys(timelineMap);
                const dailyCounts = Object.values(timelineMap);

                // Aggregation: City (New)
                const cityMap = {};
                data.forEach(r => {
                    // Try to get City - could be in r.city or we might need to parse? Assuming r.city exists from viewing previous code.
                    const city = r.city || 'N√£o identificado';
                    if (!cityMap[city]) cityMap[city] = 0;
                    cityMap[city]++;
                });
                const cities = Object.keys(cityMap).sort((a, b) => cityMap[b] - cityMap[a]).slice(0, 10); // Top 10
                const cityCounts = cities.map(c => cityMap[c]);


                // HTML Structure
                reportContainer.innerHTML = `
                    <style>
                        .pdf-keep {
                            page-break-inside: avoid !important;
                            break-inside: avoid !important;
                        }
                    </style>

                    <!-- PAGE 1: OVERVIEW -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid ${primaryColor}; padding-bottom: 15px;">
                        <div>
                            <h1 style="color: ${primaryColor}; margin: 0; font-size: 22px;">Relat√≥rio de Desempenho</h1>
                            <p style="margin: 5px 0 0; color: #666; font-size: 12px;">${globalData.companyName || 'Sua Empresa'}</p>
                            <small style="color: #999; font-size: 10px;">Gerado em: ${new Date().toLocaleDateString()} √†s ${new Date().toLocaleTimeString()}</small>
                        </div>
                        <img src="${logoSrc}" style="height: 50px; object-fit: contain;">
                    </div>

                    <div class="pdf-keep" style="display: flex; gap: 15px; margin-bottom: 30px;">
                        <div style="flex: 1; background: ${primaryColor}15; padding: 15px; border-radius: 8px; border-left: 4px solid ${primaryColor};">
                            <div style="font-size: 10px; text-transform: uppercase; color: #666; font-weight: bold;">Total Avalia√ß√µes</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${primaryColor};">${total}</div>
                        </div>
                        <div style="flex: 1; background: ${primaryColor}15; padding: 15px; border-radius: 8px; border-left: 4px solid ${primaryColor};">
                            <div style="font-size: 10px; text-transform: uppercase; color: #666; font-weight: bold;">M√©dia Geral</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${primaryColor};">${avg} <span style="font-size: 14px;">‚òÖ</span></div>
                        </div>
                        <div style="flex: 1; background: ${primaryColor}15; padding: 15px; border-radius: 8px; border-left: 4px solid ${primaryColor};">
                            <div style="font-size: 10px; text-transform: uppercase; color: #666; font-weight: bold;">NPS</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${primaryColor};">${nps}</div>
                        </div>
                    </div>

                    <div class="pdf-keep" style="display: flex; gap: 15px; margin-bottom: 20px; height: 250px;">
                        <div style="flex: 1; border: 1px solid #eee; border-radius: 8px; padding: 10px;">
                            <h4 style="margin: 0 0 10px 0; text-align: center; color: #555; font-size: 12px;">Volume por Atendente</h4>
                            <div style="position: relative; height: 200px; width: 100%;">
                                <canvas id="pdfBarChart"></canvas>
                            </div>
                        </div>
                        <div style="flex: 1; border: 1px solid #eee; border-radius: 8px; padding: 10px;">
                            <h4 style="margin: 0 0 10px 0; text-align: center; color: #555; font-size: 12px;">Distribui√ß√£o de Notas</h4>
                            <div style="position: relative; height: 200px; width: 100%;">
                                <canvas id="pdfPieChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- FORCE PAGE BREAK -->
                    <div class="html2pdf__page-break"></div>

                    <!-- PAGE 2: TRENDS & LOCATION -->
                    <h3 style="margin-bottom: 20px; color: ${primaryColor}; margin-top: 30px; font-size: 16px;">Tend√™ncias e Localiza√ß√£o</h3>
                    
                    <div class="pdf-keep" style="margin-bottom: 30px; height: 250px; border: 1px solid #eee; border-radius: 8px; padding: 10px;">
                         <h4 style="margin: 0 0 10px 0; text-align: center; color: #555; font-size: 12px;">Evolu√ß√£o Di√°ria</h4>
                         <div style="position: relative; height: 200px; width: 100%;">
                             <canvas id="pdfLineChart"></canvas>
                         </div>
                    </div>

                    <div class="pdf-keep" style="margin-bottom: 30px; height: 250px; border: 1px solid #eee; border-radius: 8px; padding: 10px;">
                         <h4 style="margin: 0 0 10px 0; text-align: center; color: #555; font-size: 12px;">Volume por Cidade (Top 10)</h4>
                         <div style="position: relative; height: 200px; width: 100%;">
                             <canvas id="pdfCityChart"></canvas>
                         </div>
                    </div>

                    <!-- FORCE PAGE BREAK -->
                    <div class="html2pdf__page-break"></div>

                    <!-- PAGE 3: ATTENDANTS -->
                    <h3 style="margin-bottom: 15px; color: #333; border-left: 4px solid ${primaryColor}; padding-left: 10px; margin-top: 30px; font-size: 16px;">Desempenho por Atendente</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 40px;">
                        <thead style="background: ${primaryColor}; color: white;">
                            <tr>
                                <th style="padding: 8px; text-align: left;">Atendente</th>
                                <th style="padding: 8px; text-align: center;">Total</th>
                                <th style="padding: 8px; text-align: center;">M√©dia</th>
                                <th style="padding: 8px; text-align: center;">NPS (Est.)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(attendantsMap).map(([name, stat], i) => {
                    const statAvg = (stat.sum / stat.count).toFixed(1);
                    return `
                                <tr class="pdf-keep" style="background: ${i % 2 === 0 ? '#f9f9f9' : '#fff'}; border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;"><strong>${name}</strong></td>
                                    <td style="padding: 8px; text-align: center;">${stat.count}</td>
                                    <td style="padding: 8px; text-align: center; font-weight: bold; color: ${statAvg >= 4 ? 'green' : (statAvg <= 2 ? 'red' : 'orange')}">${statAvg}</td>
                                    <td style="padding: 8px; text-align: center;">-</td> 
                                </tr>
                                `;
                }).join('')}
                        </tbody>
                    </table>

                    <!-- FORCE PAGE BREAK? Maybe let flow, assuming table fits or flows to page 4 -->
                    
                    <h3 style="margin-bottom: 15px; color: #333; border-left: 4px solid ${primaryColor}; padding-left: 10px; margin-top: 30px; font-size: 16px;">Detalhamento Geral</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                        <thead style="background: ${primaryColor}; color: white;">
                            <tr>
                                <th style="padding: 8px; text-align: left;">Data</th>
                                <th style="padding: 8px; text-align: left;">Atendente</th>
                                <th style="padding: 8px; text-align: left;">Nota</th>
                                <th style="padding: 8px; text-align: left;">Coment√°rio</th>
                                <th style="padding: 8px; text-align: left;">Local</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map((r, i) => `
                                <tr class="pdf-keep" style="background: ${i % 2 === 0 ? '#f9f9f9' : '#fff'}; border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px; width: 15%;">${new Date(r.createdAt).toLocaleDateString()}</td>
                                    <td style="padding: 8px; width: 20%;"><strong>${r.attendant ? r.attendant.name : 'Geral'}</strong></td>
                                    <td style="padding: 8px; width: 10%; color: ${r.stars >= 4 ? 'green' : (r.stars <= 2 ? 'red' : 'orange')}; font-weight: bold;">
                                        ${r.stars} ‚òÖ
                                    </td>
                                    <td style="padding: 8px; width: 35%; color: #555;">${r.comment || '-'}</td>
                                    <td style="padding: 8px; width: 20%; color: #777;">${r.city || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                     <div style="margin-top: 20px; text-align: center; color: #999; font-size: 10px;">
                        Relat√≥rio gerado automaticamente por Avalia J√°.
                    </div>
                `;

                // 3. Append and Scroll
                document.body.appendChild(reportContainer);
                window.scrollTo(0, 0);

                // Render Charts
                // Bar
                const names = Object.keys(attendantsMap);
                const counts = names.map(n => attendantsMap[n].count);
                new Chart(reportContainer.querySelector('#pdfBarChart'), {
                    type: 'bar',
                    data: { labels: names, datasets: [{ label: 'Avalia√ß√µes', data: counts, backgroundColor: primaryColor, barThickness: 20 }] },
                    options: { animation: false, responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });

                // Pie
                const starCounts = [0, 0, 0, 0, 0];
                data.forEach(r => { if (r.stars >= 1 && r.stars <= 5) starCounts[r.stars - 1]++; });
                new Chart(reportContainer.querySelector('#pdfPieChart'), {
                    type: 'doughnut',
                    data: { labels: ['1‚òÖ', '2‚òÖ', '3‚òÖ', '4‚òÖ', '5‚òÖ'], datasets: [{ data: starCounts, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#15803d'] }] },
                    options: { animation: false, responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });

                // Line (Evolution)
                new Chart(reportContainer.querySelector('#pdfLineChart'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Avalia√ß√µes por Dia',
                            data: dailyCounts,
                            borderColor: primaryColor,
                            backgroundColor: primaryColor + '20',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: { animation: false, responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
                });

                // Horizontal Bar (Cities)
                new Chart(reportContainer.querySelector('#pdfCityChart'), {
                    type: 'bar',
                    data: {
                        labels: cities,
                        datasets: [{
                            label: 'Avalia√ß√µes por Cidade',
                            data: cityCounts,
                            backgroundColor: primaryColor,
                            barThickness: 15
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Horizontal
                        animation: false,
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });

                // Wait
                await new Promise(r => setTimeout(r, 1000));

                const opt = {
                    margin: [0.2, 0.2, 0.2, 0.2],
                    filename: `relatorio_${globalData.companyName || 'avaliaja'}_${Date.now()}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };

                // Generate Blob and Open
                const pdfBlobUrl = await html2pdf().set(opt).from(reportContainer).output('bloburl');
                window.open(pdfBlobUrl, '_blank');

                document.body.removeChild(reportContainer);
            } catch (err) {
                console.error("Erro ao gerar PDF:", err);
                alert("Erro ao gerar PDF. Verifique o console.");
            } finally {
                // Restore
                originalDisplays.forEach(item => {
                    item.element.style.display = item.display;
                });
                if (btn) btn.innerText = originalText;

                // Allow scrolling again
                document.body.style.overflow = '';
            }
        }

        // --- MODAL LOGIC ---
        function openAttendantModal(attId = null) {
            const m = document.getElementById('attendantModal');
            m.classList.add('active');

            if (attId) {
                // Edit Mode
                const data = globalData.attendants.find(a => a.id === attId);
                if (!data) return alert("Erro: Atendente n√£o encontrado.");

                document.getElementById('attendantIdInput').value = data.id;
                document.getElementById('attendantNameInput').value = data.name;
                document.getElementById('attendantPhoneInput').value = data.phone || '';
                document.getElementById('attendantSectorInput').value = data.sector || '';
                document.getElementById('attendantIntegrationIdInput').value = data.integrationId || '';
                document.getElementById('attendantNotifyInput').checked = data.notify !== false; // Default true
                (conceptually)
                document.getElementById('attendantActiveInput').checked = data.active !== false;
                document.getElementById('resultArea').style.display = 'none';
            } else {
                // Create Mode
                document.getElementById('attendantIdInput').value = '';
                document.getElementById('attendantNameInput').value = '';
                document.getElementById('attendantPhoneInput').value = '';
                document.getElementById('attendantSectorInput').value = '';
                document.getElementById('attendantIntegrationIdInput').value = '';
                document.getElementById('attendantNotifyInput').checked = true;
                document.getElementById('attendantActiveInput').checked = true;
                document.getElementById('resultArea').style.display = 'none';
            }
        }

        function closeAttendantModal() {
            document.getElementById('attendantModal').classList.remove('active');
            // Wait a bit to refresh so the user sees the close animation?
            // Actually, we should refresh list immediately.
            loadDashboard();
        }

        function getCompSlug() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            return user.companySlug || 'empresa'; // Fallback
        }

        async function saveAttendant() {
            const id = document.getElementById('attendantIdInput').value.trim();
            const name = document.getElementById('attendantNameInput').value.trim();
            if (!name) return alert("O nome √© obrigat√≥rio.");

            const phone = document.getElementById('attendantPhoneInput').value.trim();
            const sector = document.getElementById('attendantSectorInput').value.trim();
            const integrationId = document.getElementById('attendantIntegrationIdInput').value.trim();
            const notify = document.getElementById('attendantNotifyInput').checked;
            const active = document.getElementById('attendantActiveInput').checked;

            const btn = document.querySelector('button[onclick="saveAttendant()"]');
            const originalText = btn.innerText;
            btn.innerText = "Salvando...";
            btn.disabled = true;

            const payload = {
                name,
                phone: phone || null,
                sector: sector || null,
                integrationId: integrationId || null,
                notify,
                active
            };

            try {
                let res;
                if (id) {
                    // Update
                    res = await fetch(`/api/atendentes/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(payload)
                    });
                } else {
                    // Create
                    res = await fetch('/api/atendentes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(payload)
                    });
                }

                if (res.ok) {
                    const saved = await res.json();

                    if (id) {
                        alert('Atendente atualizado com sucesso!');
                        closeAttendantModal();
                    } else {
                        // If created, populate link area
                        const slug = getCompSlug();
                        const origin = window.location.origin;
                        const fullLink = `${origin}/${slug}/${encodeURIComponent(saved.name)}`;

                        document.getElementById('generatedLink').value = fullLink;
                        document.getElementById('resultArea').style.display = 'block';
                        btn.innerText = "Salvo!";

                        // We also refresh the background list, but don't close modal yet so they can copy link
                        loadDashboard();

                        setTimeout(() => {
                            btn.innerText = originalText;
                            btn.disabled = false;
                        }, 2000);
                        return; // Exit early to keep modal open
                    }

                } else {
                    const err = await res.json();
                    alert('Erro: ' + (err.error || 'Erro desconhecido'));
                }
            } catch (e) {
                console.error(e);
                alert('Erro de conex√£o: ' + (e.message || e));
            }

            btn.innerText = originalText;
            btn.disabled = false;
        }

        function copyLink() {
            const copyText = document.getElementById("generatedLink");
            copyText.select();
            copyText.setSelectionRange(0, 99999); // Mobile compatibility
            navigator.clipboard.writeText(copyText.value);

            const btn = document.getElementById('btnCopy');
            const original = btn.innerText;
            btn.innerText = "Copiado!";
            btn.style.background = "#00e676";
            setTimeout(() => {
                btn.innerText = original;
                btn.style.background = "var(--primary-blue)";
            }, 2000);
        }

        function copyLinkByName(name) {
            const slug = getCompSlug();
            const origin = window.location.origin;
            // Format: domain.com/SLUG/NAME
            const fullLink = `${origin}/${slug}/${encodeURIComponent(name)}`;

            navigator.clipboard.writeText(fullLink);

            // Visual feedback
            const btn = document.getElementById(`btn-copy-${name}`);
            if (btn) {
                const original = btn.innerText;
                btn.innerText = "Copiado! ‚úì";
                btn.style.background = "#00e676";
                btn.style.color = "#fff";
                setTimeout(() => {
                    btn.innerText = original;
                    btn.style.background = "rgba(255,255,255,0.1)";
                    btn.style.color = "#fff";
                }, 2000);
            }
        }

        async function deleteAttendant(id, name) {
            if (!confirm(`Tem certeza que deseja excluir ${name}? Todas as avalia√ß√µes dele ser√£o apagadas.`))
                return;

            try {
                const res = await fetch(`/api/atendentes/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    loadDashboard(); // Reload logic
                } else {
                    alert("Erro ao excluir");
                }
            } catch (e) {
                console.error(e);
            }
        }

        window.onclick = function (e) {
            // Only close if clicked strictly on overlay, not content
            if (e.target == document.getElementById('attendantModal')) closeAttendantModal();
        }

        // Init
        loadDashboard();

        // --- PREVIEW LOGIC (POSTMESSAGE) ---
        function updatePreviewColor(color) {
            const frame = document.getElementById('previewIframe');
            if (frame && frame.contentWindow) {
                frame.contentWindow.postMessage({ type: 'UPDATE_COLOR', color: color }, '*');
            }
        }

        function updatePreviewText(text) {
            const frame = document.getElementById('previewIframe');
            if (frame && frame.contentWindow) {
                frame.contentWindow.postMessage({ type: 'UPDATE_TEXT', text: text }, '*');
            }
        }

        function togglePreviewObs(show) {
            const frame = document.getElementById('previewIframe');
            if (frame && frame.contentWindow) {
                frame.contentWindow.postMessage({ type: 'TOGGLE_OBS', show: show }, '*');
            }
        }

        function updatePreviewLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const base64 = e.target.result;
                    // Show small preview in dashboard
                    document.getElementById('logoPreviewContainer').style.display = 'block';
                    document.getElementById('logoPreviewImg').src = base64;
                    // Send to Iframe
                    const frame = document.getElementById('previewIframe');
                    if (frame && frame.contentWindow) {
                        frame.contentWindow.postMessage({ type: 'UPDATE_LOGO', src: base64 }, '*');
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- NEW FEATURES LOGIC ---

        async function loadUsers() {
            try {
                const res = await fetch('/api/company/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await res.json();
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';

                // Ensure current user is in the list
                const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                const hasCurrent = users.find(u => u.email === currentUser.email);

                let displayUsers = [...users];
                if (currentUser.email && !hasCurrent) {
                    displayUsers.unshift({
                        name: currentUser.name + ' (Voc√™)',
                        email: currentUser.email,
                        role: 'admin', // Assume admin
                        isSelf: true
                    });
                }

                displayUsers.forEach(u => {
                    const isSelf = u.email === currentUser.email || u.isSelf;
                    tbody.innerHTML += `
                <tr>
                    <td>${u.name} ${isSelf ? `<span class="badge" style="background:var(--accent); font-size:0.7em;">VOC√ä</span>` : ''}</td>
                        <td>${u.email}</td>
                    <td><span class="badge" style="background: rgba(255,255,255,0.1);">${u.role || 'user'}</span></td>
                    <td><span style="color: var(--success);">Ativo</span></td>
                    <td>
                        <button onclick="changeUserPassword('${u.id}')"
                            style="border:none; background:none; cursor:pointer; margin-right: 10px;"
                            title="Alterar Senha">üîë</button>
                        ${!isSelf ? `<button onclick="alert('A√ß√£o restrita.')" style="border:none; background:none; cursor:pointer;" title="Remover">‚ùå</button>` : ''}
                    </td >
                </tr >
                        `;
                });
            } catch (e) { console.error(e); }
        }

        function openUserModal() {
            document.getElementById('userModal').classList.add('active');
        }

        async function handleInviteUser(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                name: form.name.value,
                email: form.email.value,
                password: form.password.value
            };

            try {
                const res = await fetch('/api/company/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token} ` },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    alert('Usu√°rio convidado!');
                    document.getElementById('userModal').classList.remove('active');
                    loadUsers();
                    form.reset();
                } else {
                    alert('Erro ao convidar');
                }
            } catch (e) { console.error(e); }
        }

        async function saveIntegrations(e) {
            e.preventDefault();
            const whatsappRaw = document.getElementById('whatsappInput') ?
                document.getElementById('whatsappInput').value : '';
            // Split comma, trim
            const whatsappNumbers = whatsappRaw.split(',').map(s => s.trim()).filter(s => s);

            const notificationRule = document.getElementById('notifyRuleInput') ?
                document.getElementById('notifyRuleInput').value : 'all';

            // N8N Webhook
            const webhookUrl = document.getElementById('n8nWebhookInput') ?
                document.getElementById('n8nWebhookInput').value : '';

            try {
                const res = await fetch('/api/company/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token} ` },
                    body: JSON.stringify({
                        whatsapp: whatsappNumbers[0] || "", // Primary
                        notifications: JSON.stringify({
                            whatsappRule: notificationRule,
                            whatsappNumbers: whatsappNumbers, // Save array
                            webhookUrl: webhookUrl // Save N8N URL
                        })
                    })
                });
                if (res.ok) alert('Integra√ß√µes salvas com sucesso!');
            } catch (e) { console.error(e); }
        }

        async function saveAccountDetails(e) {
            e.preventDefault();
            const name = document.getElementById('companyNameInput').value;
            const area = document.getElementById('companyAreaInput').value;

            try {
                const res = await fetch('/api/company/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token} ` },
                    body: JSON.stringify({ name, area })
                });
                if (res.ok) alert('Dados salvos!');
            } catch (e) { console.error(e); }
        }

        // --- DATE FILTER & PDF LOGIC ---

        function filterDashboardByDate() {
            const startInput = document.getElementById('dateStart').value;
            const endInput = document.getElementById('dateEnd').value;

            if (!globalData.originalReviews) {
                // Keep backup of originals on first run
                globalData.originalReviews = [...globalData.reviews];
            }

            let filtered = [...globalData.originalReviews];

            if (startInput) {
                const start = new Date(startInput);
                filtered = filtered.filter(r => new Date(r.createdAt) >= start);
            }
            if (endInput) {
                const end = new Date(endInput);
                end.setHours(23, 59, 59); // End of day
                filtered = filtered.filter(r => new Date(r.createdAt) <= end);
            } // Recalculate Metrics const
            total = filtered.length; const avg = total > 0 ? (filtered.reduce((acc, r) => acc + r.stars, 0) / total)
                : 0;

            // NPS Calculation
            const promoters = filtered.filter(r => r.stars >= 5).length;
            const detractors = filtered.filter(r => r.stars <= 3).length; const nps = total > 0 ?
                Math.round(((promoters - detractors) / total) * 100) : 0;

            // Update UI
            renderMetrics({
                average: avg,
                total: total,
                nps: nps,
                activeAttendants: globalData.metrics.activeAttendants // Keep static
            });

            // Update Global for other renders
            globalData.reviews = filtered;

            // Recalc chart data (mock reconstruction)
            // Ideally we'd re-aggregate by attendant, but for now we rely on review attendant data
            const attMap = {};
            filtered.forEach(r => {
                const name = r.attendant ? r.attendant.name : 'Geral';
                if (!attMap[name]) attMap[name] = 0;
                attMap[name]++;
            });
            // Rebuild mock attendant object for chart
            const mockAttendants = Object.keys(attMap).map(name => ({
                name: name,
                _count: { reviews: attMap[name] }
            }));

            renderCharts(mockAttendants); // This replots Main Chart
            renderRecentReviews(filtered.slice(0, 30));
        }

        function exportDashboardPDF() {
            const element = document.getElementById('view-dashboard');
            const opt = {
                margin: 0.5,
                filename: 'Relatorio_AvaliaJa.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // Hide buttons for cleaner PDF
            const buttons = element.querySelectorAll('button');
            buttons.forEach(b => b.style.display = 'none');

            html2pdf().set(opt).from(element).save().then(() => {
                // Restore buttons
                buttons.forEach(b => b.style.display = 'block');
            });
        }



        // Load Users when tab is clicked
        const originalSwitchTab = switchTab;
        switchTab = function (name, el) {
            originalSwitchTab(name, el);
            if (name === 'gestores') loadUsers();
        }

        // --- INTEGRATIONS LOGIC ---
        function addNewIntegrationCard(type = null, initialData = {}) {
            const select = document.getElementById('newIntegrationSelect');
            const selectedType = type || select.value;
            if (!selectedType) { alert('Selecione um servi√ßo.'); return; }

            const container = document.getElementById('integrationsContainer');
            const cardId = 'int-' + Date.now() + Math.random().toString(36).substr(2, 5);

            // MAP CONFIG
            const config = {
                whatsapp: {
                    name: 'WhatsApp', color: '#25D366', icon: '<img src="images/whatsapp.png" style="width:40px;">'
                },
                lnassist: { name: 'LnAssist', color: '#ff9800', icon: 'ü©∫' },
                worklab: { name: 'WorkLab', color: '#2196f3', icon: 'üß™' },
                amplimed: { name: 'Amplimed', color: '#9c27b0', icon: '‚öïÔ∏è' },
                webhook: { name: 'Webhook', color: '#ea4b71', icon: 'üîå' }
            };
            const conf = config[selectedType] || config.webhook;
            const displayName = initialData.name || conf.name;

            // CUSTOM RENDER FOR LN ASSIST
            if (selectedType === 'lnassist') {
                renderLnAssistCard(container, initialData);
                if (!type) select.value = '';
                return;
            }

            const div = document.createElement('article');
            div.className = 'glass-panel';
            div.style.cssText = 'padding: 30px; position: relative; overflow: hidden; display: flex; flex-direction: column;';
            div.id = cardId;

            div.innerHTML = `
                        <div style="position: relative; z-index: 1;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                                <span style="font-size: 2rem;">${typeof conf.icon === 'string' && !conf.icon.startsWith('<') ? conf.icon : ''}</span>
                                        ${typeof conf.icon === 'string' && conf.icon.startsWith('<') ? conf.icon : ''}
                                            <div style="flex: 1;">
                                            <input type="text" value="${displayName}" class="integration-title"
                                                style="background: transparent; border: none; color: #fff; font-size: 1.2rem; font-weight: bold; width: 100%; border-bottom: 1px solid transparent; transition: 0.3s;"
                                                onfocus="this.style.borderBottom='1px solid #fff'"
                                                onblur="this.style.borderBottom='1px solid transparent'">
                                            <p style="font-size: 0.85rem; color: var(--text-muted); margin: 0;">
                                                ${selectedType.toUpperCase()}</p>
                            </div>
                            <button onclick="deleteIntegration('${cardId}')"
                                style="background:transparent; border:none; color:#ef4444; cursor:pointer;"
                                title="Remover">üóëÔ∏è</button>
                        </div>

                        <form onsubmit="saveIntegration(event, '${cardId}')">
                            <input type="hidden" name="type" value="${selectedType}">

                            ${getIntegrationFields(selectedType, initialData)}

                            <button type="submit" class="btn-glow"
                                style="width: 100%; justify-content: center; background: ${conf.color};">
                                Salvar Configura√ß√£o
                            </button>
                        </form>
                        </div >
                        `;
            container.appendChild(div);
            if (!type) select.value = '';
        }

        function getIntegrationFields(type, data) {
            if (type === 'whatsapp') {
                return `
                        < div style = "margin-bottom: 15px;" >
                            <label style="display:block; margin-bottom: 8px; font-size: 0.85rem; color: #ccc;">N√∫mero
                                (com DDD)</label>
                            <input type="text" name="value" value="${data.value || ''}" placeholder="Ex: 5511999999999"
                                style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.4); color: #fff;">
                            <p style="font-size: 0.75rem; color: #666; margin-top: 5px;">Separe m√∫ltiplos por v√≠rgula.
                            </p>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display:block; margin-bottom: 8px; font-size: 0.85rem; color: #ccc;">Regra de
                                Disparo</label>
                            <select name="rule"
                                style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: #0a1628; color: #fff;">
                                <option value="all" ${data.rule === 'all' ? 'selected' : ''}>üîî Todas as avalia√ß√µes
                                </option>
                                <option value="bad" ${data.rule === 'bad' ? 'selected' : ''}>‚ö†Ô∏è Apenas notas baixas (1-2)
                                </option>
                                <option value="off" ${data.rule === 'off' ? 'selected' : ''}>üîï Desativado</option>
                            </select>
                        </div>
                    `;
            }
            return `
                        < div style = "margin-bottom: 15px;" >
                            <label style="display:block; margin-bottom: 8px; font-size: 0.85rem; color: #ccc;">URL /
                                Token / Chave API</label>
                            <input type="text" name="value" value="${data.value || ''}"
                                placeholder="Cole aqui a credencial ou URL..."
                                style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.4); color: #fff;">
                        </div>
                    `;
        }

        async function deleteIntegration(cardId) {
            if (confirm('Remover esta integra√ß√£o? (Clique em Salvar para persistir)')) {
                document.getElementById(cardId).remove();
            }
        }


        async function saveIntegration(e, cardId) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Salvando...";
            btn.disabled = true;

            const integrations = [];
            document.querySelectorAll('#integrationsContainer article').forEach(article => {
                const cardForm = article.querySelector('form');
                if (!cardForm) return;
                const type = cardForm.querySelector('input[name="type"]').value;
                const name = article.querySelector('.integration-title').value;
                const value = cardForm.querySelector('input[name="value"]').value;
                const rule = cardForm.querySelector('select[name="rule"]')?.value;
                integrations.push({ type, name, value, rule });
            });

            try {
                const resGet = await fetch('/api/company/settings', {
                    headers: {
                        'Authorization': `Bearer
                        ${token} `
                    }
                });
                const current = await resGet.json();
                const newSettings = current.settings || {};
                newSettings.integrations = integrations;

                const formData = new FormData();
                formData.append('settings', JSON.stringify(newSettings));
                // We should also update legacy fields for compatibility if desired,
                // but let's stick to settings.integrations as primary now.
                // Legacy fields (whatsapp, notifications) might be overwritten by emptiness if we don't send them.
                // The backend `updateSettings` updates only what is sent.
                // The backend `updateSettings` updates only what is sent.
                // So legacy notifications remain unless we update them.
                // It's fine.

                const res = await fetch('/api/company/settings', {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token} ` },
                    body: formData
                });

                if (res.ok) alert('Integra√ß√µes salvas com sucesso!');
                else alert('Erro ao salvar.');

            } catch (e) { console.error(e); alert('Erro ao salvar.'); }

            btn.innerText = originalText;
            btn.disabled = false;
        }
        // --- CUSTOMIZATION HELPERS ---
        function addQuestionField(value = '') {
            const list = document.getElementById('extraQuestionsList');
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.gap = '10px';
            div.innerHTML = `
                        < input type = "text" class="extra-question-input" value = "${value}"
                    placeholder = "Digite a pergunta..."
                    style = "flex: 1; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: #fff;" >
                        <button type="button" onclick="this.parentElement.remove()"
                            style="background: transparent; border: none; color: #ef4444; cursor: pointer;">üóëÔ∏è</button>
                    `;
            list.appendChild(div);
        }

        function updateMockupLogo(logoUrl) {
            const iframe = document.getElementById('mobilePreviewIframe');
            if (iframe && iframe.contentWindow && iframe.contentWindow.document) {
                const logoImgs = iframe.contentWindow.document.querySelectorAll('.logo-top img');
                logoImgs.forEach(img => img.src = logoUrl);
            }
        }
        async function changeUserPassword(userId) {
            const newPass = prompt("Digite a nova senha para este usu√°rio (min 6 caracteres):");
            if (!newPass) return;
            if (newPass.length < 6) return alert("Senha muito curta.");
            try {
                const res = await fetch(`/api/company/users/${userId}/password`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ password: newPass })
                });
                const data = await res.json();
                if (res.ok) alert(data.message);
                else alert(data.error || 'Erro ao alterar senha.');
            } catch (e) {
                console.error(e);
                alert('Erro ao alterar senha.');
            }
        } 
    </script>
    <!-- SUGGESTION MODAL -->
    <div class="modal-overlay" id="suggestionModal">
        <div class="modal-content glass-panel" style="max-width: 500px;">
            <h2 style="margin-bottom: 20px;">Nova Sugest√£o</h2>
            <form onsubmit="submitSuggestion(event)">
                <textarea id="suggestionText" placeholder="Descreva sua sugest√£o..." required
                    style="width: 100%; height: 120px; padding: 12px; margin-bottom: 20px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: #fff; resize: vertical;"></textarea>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn-secondary" onclick="closeSuggestionModal()">Cancelar</button>
                    <button type="submit" class="btn-glow">Enviar Sugest√£o</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- SUGGESTIONS LOGIC ---
        async function loadSuggestions() {
            const list = document.getElementById('suggestionsList');
            if (!list) return;

            try {
                const res = await fetch('/api/suggestions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const suggestions = await res.json();

                list.innerHTML = '';
                if (suggestions.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:#666;">Nenhuma sugest√£o ainda. Seja o primeiro!</p>';
                    return;
                }

                suggestions.forEach(s => {
                    const div = document.createElement('div');
                    div.style.cssText = 'background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 15px;';
                    div.innerHTML = `
                            <div style="flex: 1;">
                                <p style="margin: 0; color: #fff; font-size: 1rem;">${s.text}</p>
                                <span style="font-size: 0.75rem; color: #666;">${new
                            Date(s.createdAt).toLocaleDateString()}</span>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button onclick="voteSuggestion(${s.id}, 'like')" class="vote-btn"
                                    style="background: rgba(0,255,0,0.1); color: #4ade80; border: 1px solid rgba(0,255,0,0.2); padding: 5px 10px; border-radius: 6px; cursor: pointer;">
                                    üëç ${s.likes}
                                </button>
                                <button onclick="voteSuggestion(${s.id}, 'dislike')" class="vote-btn"
                                    style="background: rgba(255,0,0,0.1); color: #f87171; border: 1px solid rgba(255,0,0,0.2); padding: 5px 10px; border-radius: 6px; cursor: pointer;">
                                    üëé ${s.dislikes}
                                </button>
                            </div>
                            `;
                    list.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                list.innerHTML = '<p style="color:red">Erro ao carregar.</p>';
            }
        }

        async function voteSuggestion(id, type) {
            try {
                const res = await fetch(`/api/suggestions/${id}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ type })
                });
                if (res.ok) {
                    loadSuggestions();
                }
            } catch (e) { console.error(e); }
        }

        function openSuggestionModal() {
            document.getElementById('suggestionModal').classList.add('active');
        }
        function closeSuggestionModal() {
            document.getElementById('suggestionModal').classList.remove('active');
        }

        async function submitSuggestion(e) {
            e.preventDefault();
            const text = document.getElementById('suggestionText').value;
            if (!text) return;

            try {
                const res = await fetch('/api/suggestions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ text })
                });
                if (res.ok) {
                    alert('Sugest√£o enviada!');
                    closeSuggestionModal();
                    document.getElementById('suggestionText').value = '';
                    loadSuggestions();
                } else alert('Erro ao enviar.');
            } catch (e) { console.error(e); }
        }

        // --- SAAS ADMIN LOGIC ---
        let adminPlanChart = null;

        async function loadAdminDashboard() {
            try {
                const res = await fetch('/api/admin/dashboard', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                document.getElementById('adminTotalCompanies').innerText = data.companies.total;
                document.getElementById('adminTotalReviews').innerText = data.reviews.total;
                document.getElementById('adminTotalAttendants').innerText = data.attendants.active;
                document.getElementById('adminActiveCompanies').innerText = data.companies.active;

                renderAdminCharts(data.byPlan);
            } catch (e) { console.error(e); }
        }

        function renderAdminCharts(byPlan) {
            const ctx = document.getElementById('adminPlanChart').getContext('2d');
            if (adminPlanChart) adminPlanChart.destroy();

            const labels = byPlan.map(p => p.plan);
            const counts = byPlan.map(p => p._count.id);

            adminPlanChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: ['#4d4dff', '#00e676', '#ffb300']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } }
                }
            });
        }

        async function loadAdminCompanies() {
            try {
                const res = await fetch('/api/admin/companies', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const companies = await res.json();
                renderAdminCompaniesTable(companies);
            } catch (e) { console.error(e); }
        }

        function renderAdminCompaniesTable(companies) {
            const tbody = document.getElementById('adminCompaniesTableBody');
            tbody.innerHTML = companies.map(c => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 15px;">${c.name}</td>
                    <td style="padding: 15px; color: var(--text-muted); font-size: 0.9em;">#${c.displayId || '-'}</td>
                    <td style="padding: 15px; color: var(--accent);">${c.slug}</td>
                    <td style="padding: 15px;"><span class="badge" style="background: rgba(255,255,255,0.1);">${c.plan}</span></td>
                    <td style="padding: 15px;">${c._count.attendants}</td>
                    <td style="padding: 15px;">${c._count.reviews}</td>
                    <td style="padding: 15px;">
                        <span style="color: ${c.active ? '#00e676' : '#ef4444'}">
                            ${c.active ? '‚óè Ativo' : '‚óã Inativo'}
                        </span>
                    </td>
                    <td style="padding: 15px;">
                        <div style="display: flex; gap: 5px;">
                            <button onclick="window.location.href = '/${c.slug}/dashboard'" 
                                class="btn-glow" style="padding: 5px 12px; font-size: 0.8rem; background: var(--accent);">Ver Dados</button>
                            <button onclick="openAdminEditModal('${c.id}', '${c.name.replace(/'/g, "\\'")}', '${c.plan}', ${c.active}, '${(c.allowedIntegrations || '[]').replace(/'/g, "\\'")}')" 
                                class="btn-glow" style="padding: 5px 12px; font-size: 0.8rem;">Editar</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openAdminEditModal(id, name, plan, active, allowedStr) {
            document.getElementById('adminEditCompanyId').value = id;
            document.getElementById('adminEditCompanyName').value = name;
            document.getElementById('adminEditCompanyPlan').value = plan;
            document.getElementById('adminEditCompanyActive').checked = active;

            // Handle Integrations
            let allowed = [];
            try { allowed = allowedStr ? JSON.parse(allowedStr) : []; } catch (e) { }

            document.getElementById('adminIntWhatsapp').checked = allowed.includes('whatsapp');
            document.getElementById('adminIntLnAssist').checked = allowed.includes('lnassist');

            document.getElementById('adminEditModal').classList.add('active');
        }

        async function handleAdminUpdateCompany(event) {
            event.preventDefault();
            const id = document.getElementById('adminEditCompanyId').value;
            const name = document.getElementById('adminEditCompanyName').value;
            const plan = document.getElementById('adminEditCompanyPlan').value;
            const active = document.getElementById('adminEditCompanyActive').checked;

            // Collect Integrations
            const ints = [];
            if (document.getElementById('adminIntWhatsapp').checked) ints.push('whatsapp');
            if (document.getElementById('adminIntLnAssist').checked) ints.push('lnassist');

            try {
                const res = await fetch(`/api/admin/companies/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name, plan, active, allowedIntegrations: JSON.stringify(ints) })
                });

                if (res.ok) {
                    alert('Empresa atualizada!');
                    document.getElementById('adminEditModal').classList.remove('active');
                    loadAdminCompanies();
                } else {
                    alert('Erro ao atualizar.');
                }
            } catch (e) { console.error(e); }
        }

        // --- ADMIN INTEGRATIONS TAB LOGIC ---

        async function loadAdminIntegrations() {
            try {
                const res = await fetch('/api/admin/companies', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const companies = await res.json();
                renderAdminIntegrationsTable(companies);
            } catch (e) { console.error(e); }
        }

        function renderAdminIntegrationsTable(companies) {
            const tbody = document.getElementById('adminIntegrationsTableBody');
            const search = document.getElementById('adminIntSearch').value.toLowerCase();

            const filtered = companies.filter(c => c.name.toLowerCase().includes(search));

            tbody.innerHTML = filtered.map(c => {
                let allowed = [];
                try { allowed = c.allowedIntegrations ? JSON.parse(c.allowedIntegrations) : []; } catch (e) { }

                const hasWa = allowed.includes('whatsapp');
                const hasLn = allowed.includes('lnassist');

                return `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 15px;">
                        <div style="font-weight: bold;">${c.name}</div>
                        <small style="color: var(--text-muted);">${c.slug}</small>
                    </td>
                    <td style="padding: 15px;">
                        ${hasWa
                        ? '<span class="badge" style="background: rgba(37, 211, 102, 0.2); color: #25D366;">Ativo</span>'
                        : '<span class="badge" style="background: rgba(255, 255, 255, 0.05); color: #666;">Inativo</span>'}
                    </td>
                    <td style="padding: 15px;">
                        ${hasLn
                        ? '<span class="badge" style="background: rgba(255, 152, 0, 0.2); color: #ff9800;">Ativo</span>'
                        : '<span class="badge" style="background: rgba(255, 255, 255, 0.05); color: #666;">Inativo</span>'}
                    </td>
                    <td style="padding: 15px;">
                        <button onclick="openAdminIntegrationsModal('${c.id}', '${c.name.replace(/'/g, "\\'")}', '${(c.allowedIntegrations || '[]').replace(/'/g, "\\'")}')" 
                            class="btn-glow" style="padding: 5px 15px; font-size: 0.8rem;">‚öôÔ∏è Configurar</button>
                    </td>
                </tr>
            `}).join('');
        }

        // Search Listener
        document.getElementById('adminIntSearch').addEventListener('input', loadAdminIntegrations);

        function openAdminIntegrationsModal(id, name, allowedStr) {
            document.getElementById('adminIntCompanyId').value = id;
            document.getElementById('adminIntModalTitle').innerText = `Configurar: ${name}`;

            let allowed = [];
            try { allowed = allowedStr ? JSON.parse(allowedStr) : []; } catch (e) { }

            document.getElementById('chkIntWhatsapp').checked = allowed.includes('whatsapp');
            document.getElementById('chkIntLnAssist').checked = allowed.includes('lnassist');

            document.getElementById('adminIntegrationsModal').classList.add('active');
        }

        async function handleAdminUpdateIntegrations(event) {
            event.preventDefault();
            const id = document.getElementById('adminIntCompanyId').value;
            const btn = event.target.querySelector('button[type="submit"]');

            const originalText = btn.innerText;
            btn.innerText = "Salvando...";
            btn.disabled = true;

            const ints = [];
            if (document.getElementById('chkIntWhatsapp').checked) ints.push('whatsapp');
            if (document.getElementById('chkIntLnAssist').checked) ints.push('lnassist');

            try {
                // Fetch current company data first to avoid overwriting other fields (Plan, Active, Name)
                // Or ensure Backend supports partial updates. Prisma does partial update by default for updated fields?
                // `updateCompany` controller expects: { plan, active, name, allowedIntegrations }
                // If we send only `allowedIntegrations`, others meant be undefined.
                // Prisma update `data: { name, plan ... }`. If name is undefined, it might set it to undefined or ignore?
                // JavaScript: `if (name) updateData.name = name`.
                // Let's check controller.

                // Controller Logic:
                // const { plan, active, name, allowedIntegrations } = req.body;
                // data: { plan, active, name, allowedIntegrations }
                // If I send ONLY allowedIntegrations, plan/active/name will be undefined.
                // Prisma `update` will fail if I pass undefined to required fields? No, `update` only updates provided fields in `data`.
                // BUT `adminController` lines 89-94 pass them DIRECTLY.
                // `data: { plan, active, name, allowedIntegrations }`
                // If `plan` is undefined, Prisma might complain or set NULL (if nullable).
                // `plan` has default "GRATIS".

                // Correction: I must fetch the company first or the Controller needs to handle undefined.
                // The Controller provided earlier DOES NOT check for undefined. It assigns `req.body` directly.
                // Wait, I read `companyController.updateSettings` which handles partials.
                // `adminController.updateCompany` (Lines 82+) does:
                // const { plan, active, name, allowedIntegrations } = req.body;
                // await prisma.company.update({ ..., data: { plan, active, name, allowedIntegrations } })

                // If I send JSON with only `allowedIntegrations`, `name` is undefined.
                // Prisma JS Client: Passing `undefined` to a field in `data` means "Do not update". Passing `null` means Set to NULL.
                // So this IS safe if I don't send the keys at all?
                // `JSON.stringify` excludes undefined keys? No, I construct the body manually.

                const payload = { allowedIntegrations: JSON.stringify(ints) };

                const res = await fetch(`/api/admin/companies/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert('Integra√ß√µes atualizadas!');
                    document.getElementById('adminIntegrationsModal').classList.remove('active');
                    loadAdminIntegrations();
                } else {
                    alert('Erro ao atualizar.');
                }

            } catch (e) { console.error(e); alert('Erro de conex√£o'); }

            btn.innerText = originalText;
            btn.disabled = false;
        }
    </script>
    <script src="/lnassist_logic.js"></script>
    <script src="/integrations_logic.js"></script>

    <!-- LOGS MODAL -->
    <div id="logsModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; backdrop-filter: blur(5px);">
        <div class="glass-panel"
            style="width:90%; max-width:900px; height:80%; display:flex; flex-direction:column; padding:20px; position:relative;">
            <button onclick="closeLogsModal()"
                style="position:absolute; top:15px; right:15px; background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            <h2 id="logsModalTitle" style="margin-bottom:20px;">Logs</h2>

            <div style="flex:1; overflow:auto;">
                <table style="width:100%; border-collapse: collapse; color: #fff;">
                    <thead style="background: rgba(255,255,255,0.05);">
                        <tr id="logsTableHeader" style="text-align: left;">
                            <!-- Dynamic Headers -->
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <!-- Dynamic Rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>

</html>